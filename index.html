<script>
/* ========= small utils ========= */
const $ = s => document.querySelector(s);
const fmtDate = s => new Date(s).toISOString().slice(0,10);
const bySevRank = s => ({Critical:4,Important:3,Moderate:2,Medium:2,Low:1,Unknown:0}[s]||0);

function withTimeout(ms, fetchPromise) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort('timeout'), ms);
  return fetchPromise(ctrl.signal).finally(() => clearTimeout(t));
}

/* ========= render ========= */
function renderTable(rows) {
  const tbody = $('#rows');
  const table = $('#tbl');
  const status = $('#status');

  function apply() {
    const q = ($('#q').value||'').toLowerCase().trim();
    const osSel = $('#osFilter').value;
    const sortBy = $('#sortBy').value;

    let list = rows.filter(r=>{
      const blob = (r.kb+' '+(r.description||'')+' '+r.os+' '+r.severity).toLowerCase();
      if (q && !blob.includes(q)) return false;
      if (osSel && r.os !== osSel) return false;
      return true;
    });

    list.sort((a,b)=>{
      if (sortBy==='date_desc') return new Date(b.date)-new Date(a.date);
      if (sortBy==='date_asc')  return new Date(a.date)-new Date(b.date);
      if (sortBy==='os_asc')    return a.os.localeCompare(b.os);
      if (sortBy==='sev_desc')  return bySevRank(b.severity)-bySevRank(a.severity);
      return 0;
    });

    tbody.innerHTML = '';
    for (const r of list) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fmtDate(r.date)}</td>
        <td><a href="${r.url}" target="_blank" rel="noopener">${r.kb}</a></td>
        <td>${(r.description||'').replace(/</g,'&lt;')}</td>
        <td><a href="${r.knownIssuesUrl}" target="_blank" rel="noopener">Release health</a></td>
        <td>${r.os}</td>
        <td><span class="badge sev-${r.severity}">${r.severity}</span></td>`;
      tbody.appendChild(tr);
    }

    $('#rowCount').textContent = `(${list.length} updates)`;
    table.hidden = list.length===0; status.hidden = list.length!==0;
    if (list.length===0) status.textContent = 'No updates match your filters.';
  }

  // wire UI once
  $('#q').addEventListener('input', apply);
  $('#osFilter').addEventListener('change', apply);
  $('#sortBy').addEventListener('change', apply);
  $('#btnPrint').addEventListener('click', ()=>window.print());
  $('#btnEmail').addEventListener('click', ()=>{
    const subject = encodeURIComponent('Windows Updates — last 30 days');
    const body = encodeURIComponent('Open this page to view, filter, or print the latest Windows security updates from the last 30 days.');
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  });

  apply();
}

/* ========= data loaders ========= */
// 1) Static JSON (preferred)
async function loadFromJson() {
  const res = await withTimeout(7000, (signal)=>
    fetch('data.json?cb='+Date.now(), { cache:'no-store', signal })
  );
  if (!res.ok) throw new Error('data.json HTTP '+res.status);
  return res.json();
}

// 2) Live MSRC via CORS-safe proxies (fallback)
const MSRC_BASE = 'https://api.msrc.microsoft.com/cvrf/v3.0';
const PROXIES = [
  u => 'https://api.allorigins.win/raw?url='+encodeURIComponent(u),
  u => 'https://cors.isomorphic-git.org/'+u,
  u => 'https://corsproxy.io/?'+encodeURIComponent(u),
];

function minusDays(d,n){ return new Date(d.getTime()-n*86400000); }
function normalizeOS(name){
  const n=(name||'').toLowerCase();
  if(n.includes('windows 11')) return 'Windows 11';
  if(n.includes('windows 10')) return 'Windows 10';
  if(n.includes('server 2016')) return 'Server 2016';
  if(n.includes('server 2019')) return 'Server 2019';
  if(n.includes('server 2022')) return 'Server 2022';
  if(n.includes('server 2025')) return 'Server 2025';
  if(n.includes('windows server')) return 'Windows Server';
  return name||'Windows';
}
const RELEASE_HEALTH = {
  "Windows 11":"https://learn.microsoft.com/windows/release-health/",
  "Windows 10":"https://learn.microsoft.com/windows/release-health/windows10-release-information",
  "Server 2016":"https://learn.microsoft.com/windows/release-health/windows-server-release-information",
  "Server 2019":"https://learn.microsoft.com/windows/release-health/windows-server-release-information",
  "Server 2022":"https://learn.microsoft.com/windows/release-health/windows-server-release-information",
  "Server 2025":"https://learn.microsoft.com/windows/release-health/windows-server-release-information",
  "Windows Server":"https://learn.microsoft.com/windows/release-health/windows-server-release-information",
};
const extractKB = t => ((t||'').match(/KB\d{7,8}/i)||[null])[0]?.toUpperCase()||null;

async function fetchWithProxies(url, accept, timeoutMs=12000) {
  const attempts = [url, ...PROXIES.map(p=>p(url))];
  let lastErr;
  for (const u of attempts) {
    try {
      const res = await withTimeout(timeoutMs, (signal)=>fetch(u, { headers:{Accept:accept}, cache:'no-store', signal }));
      if (!res.ok) throw new Error('HTTP '+res.status);
      return await res.text();
    } catch (e) { lastErr = e; }
  }
  throw lastErr || new Error('Fetch failed');
}

function parseCvrf(xmlText, dates){
  const dom = new DOMParser().parseFromString(xmlText, 'application/xml');

  const prod = {};
  dom.querySelectorAll('ProductTree FullProductName').forEach(fp=>{
    const id = fp.getAttribute('ProductID');
    if (id) prod[id] = fp.textContent.trim();
  });

  const rows=[];
  dom.querySelectorAll('Vulnerability').forEach(v=>{
    let sev='Unknown';
    const impact = Array.from(v.querySelectorAll('Threat')).find(t=>(t.getAttribute('Type')||'').toLowerCase()==='impact');
    if (impact){
      const s = impact.textContent.toLowerCase();
      if (s.includes('critical')) sev='Critical';
      else if (s.includes('important')) sev='Important';
      else if (s.includes('moderate')) sev='Moderate';
      else if (s.includes('low')) sev='Low';
    } else {
      const score = parseFloat(v.querySelector('CVSSScoreSets BaseScore')?.textContent||'NaN');
      if(!isNaN(score)) sev = score>=9?'Critical':score>=7?'Important':score>=4?'Moderate':'Low';
    }

    v.querySelectorAll('Remediation, Remediations Remediation').forEach(rem=>{
      const type = (rem.querySelector('Type')?.textContent||'').toLowerCase();
      if(!type.includes('vendor fix')) return;

      const desc = rem.querySelector('Description')?.textContent?.trim()||'Security update';
      const kb = extractKB(desc) || extractKB(rem.textContent);
      if (!kb) return;

      const url = rem.querySelector('URL')?.textContent?.trim() || `https://support.microsoft.com/help/${kb.replace(/KB/i,'')}`;
      const prodIds = Array.from(rem.querySelectorAll('ProductID')).map(p=>p.textContent.trim()).filter(Boolean);
      const osSet = new Set(prodIds.map(id=>normalizeOS(prod[id]||id)));
      if (osSet.size===0) osSet.add('Windows');

      osSet.forEach(os=>{
        rows.push({
          date: dates.current || dates.initial || new Date().toISOString(),
          kb, url, description: desc,
          knownIssuesUrl: RELEASE_HEALTH[os] || RELEASE_HEALTH['Windows 11'],
          os, severity: sev
        });
      });
    });
  });
  return rows;
}

async function loadLiveFromMSRC() {
  const since = minusDays(new Date(), 30).toISOString();
  const updatesUrl = `${MSRC_BASE}/updates/?$filter=InitialReleaseDate ge ${since} or CurrentReleaseDate ge ${since}&$orderby=CurrentReleaseDate desc`;

  // get list
  const updJson = JSON.parse(await fetchWithProxies(updatesUrl, 'application/json', 12000));
  const ids = (updJson.value||[]).map(u=>({id:u.ID, initial:u.InitialReleaseDate, current:u.CurrentReleaseDate}));

  // fetch docs
  const all=[];
  for (const it of ids) {
    const xml = await fetchWithProxies(`${MSRC_BASE}/cvrf/${encodeURIComponent(it.id)}`, 'application/xml', 15000);
    all.push(...parseCvrf(xml, {initial:it.initial, current:it.current}));
  }

  // de-dup
  const uniq=new Map();
  for (const r of all){
    const key = [fmtDate(r.date), r.kb, r.os].join('|');
    const prev = uniq.get(key);
    if (!prev || bySevRank(r.severity) > bySevRank(prev.severity)) uniq.set(key, r);
  }
  return Array.from(uniq.values());
}

/* ========= main ========= */
(async function main(){
  const status = $('#status');

  try {
    // 1) Try static JSON (if you haven't created data.json yet this will 404 quickly)
    let rows;
    try {
      rows = await loadFromJson();
    } catch (e) {
      console.warn('data.json not available or timed out; falling back to live MSRC.', e);
      // 2) Fallback: live API via proxies
      rows = await loadLiveFromMSRC();
    }

    renderTable(rows);
  } catch (err) {
    console.error(err);
    status.innerHTML = `
      <div><strong>Couldn’t load data.</strong></div>
      <div class="muted" style="margin-top:8px">
        If this is your first deploy and <code>data.json</code> doesn’t exist yet, open the repo’s <em>Actions</em> tab and run
        <b>Build MSRC updates JSON (daily)</b>. Or just <a href="#" id="retry">try again</a>.
      </div>`;
    const retry = document.getElementById('retry');
    if (retry) retry.addEventListener('click', (e)=>{ e.preventDefault(); location.reload(); });
  }
})();
</script>
