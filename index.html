<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Windows Updates (Last 30 Days)</title>
  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;--pill:#1f2937;--ok:#16a34a;--btn:#1e293b;--btnText:#dbeafe;
      --row:#0b1220;--rowAlt:#0c1424;--border:#1f2937
    }
    html,body{background:var(--bg);color:var(--text);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;margin:0}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-weight:700;margin:0 0 16px 0}
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0 18px}
    .search{flex:1;min-width:260px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text)}
    .select,.btn{background:var(--btn);color:var(--btnText);border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn{background:#0b253f}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--bg);z-index:1}
    th,td{padding:12px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:nth-child(odd){background:var(--row)}
    tbody tr:nth-child(even){background:var(--rowAlt)}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--pill);color:#c7d2fe;font-weight:600;font-size:12px}
    .link{color:#93c5fd;text-decoration:none}
    .link:hover{text-decoration:underline}
    .nowrap{white-space:nowrap}
    .kb-list{display:flex;flex-wrap:wrap;gap:6px}
    .kb{background:#13263d;color:#e0f2fe;border:1px solid #1d3654;padding:2px 8px;border-radius:8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Windows Updates (Last 30 Days)</h1>

    <div class="toolbar">
      <input id="q" class="search" placeholder="Search CVE, KB, description, OS, etc…" />
      <select id="sort" class="select">
        <option value="new">Sort: Newest first</option>
        <option value="old">Sort: Oldest first</option>
      </select>
      <button id="print" class="btn">Print / PDF</button>
      <button id="email" class="btn">Email</button>
    </div>

    <div class="muted" id="count">0 updates</div>

    <div style="overflow:auto;margin-top:8px;border:1px solid var(--border);border-radius:10px">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:160px">CVE</th>
            <th>Description</th>
            <th style="width:160px">KB(s)</th>
            <th style="width:140px">Known Issues</th>
            <th style="width:120px">Release Date</th>
            <th style="width:90px">Source</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:12px">
      Source: Microsoft Security Response Center (SUG API/RSS, CVRF, Windows Release Health / Known-issues).
    </p>
  </div>

  <script>
    const fmtDate = s => {
      try {
        const d = new Date(s);
        return d.toLocaleDateString(undefined,{month:'short', day:'2-digit', year:'numeric'});
      } catch { return s || '—'; }
    };
    const uniq = arr => [...new Set(arr)].filter(Boolean);

    function normalize(items){
      return (items||[]).map(it=>{
        // accept both legacy and new keys
        const cves = uniq([
          ...(Array.isArray(it.cves) ? it.cves : []),
          ...(it.cve ? String(it.cve).split(/[,\s]+/) : []),
        ]);
        const kbs = uniq([
          ...(Array.isArray(it.kbs) ? it.kbs : []),
          ...(it.kb ? String(it.kb).split(/[,\s]+/) : []),
        ]);
        let ki = it.knownIssuesUrl || it.knownIssues || '';
        // best-effort: if we have a KB but no URL, create a Release-Health search URL
        if (!ki && kbs.length){
          const kb = encodeURIComponent(kbs[0]);
          ki = `https://learn.microsoft.com/search/?terms=${kb}%20known%20issues%20windows%20release%20health`;
        }
        return {
          cves, kbs,
          title: it.title || 'Windows Update',
          description: it.description || '(no description)',
          link: it.link || '',
          knownIssuesUrl: ki || '',
          releaseDate: it.releaseDate || it.date || '',
          source: it.source || '—',
        };
      });
    }

    function render(items){
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      const q = document.getElementById('q').value.trim().toLowerCase();
      const sort = document.getElementById('sort').value;

      let rows = [...items];

      // Filter
      if (q){
        rows = rows.filter(r=>{
          const hay = [
            ...r.cves, ...r.kbs, r.title, r.description, r.source, r.releaseDate
          ].join(' ').toLowerCase();
          return hay.includes(q);
        });
      }

      // Sort
      rows.sort((a,b)=>{
        const da = new Date(a.releaseDate || 0).getTime();
        const db = new Date(b.releaseDate || 0).getTime();
        return sort === 'new' ? db-da : da-db;
      });

      // Render
      for (const r of rows){
        const tr = document.createElement('tr');

        // CVE column
        const tdCve = document.createElement('td');
        if (r.cves.length){
          tdCve.innerHTML = r.cves.map(c=>{
            const u = `https://msrc.microsoft.com/update-guide/vulnerability/${encodeURIComponent(c)}`;
            return `<div><a class="link" href="${u}" target="_blank" rel="noopener">${c}</a></div>`;
          }).join('');
        } else {
          tdCve.innerHTML = '<span class="muted">N/A</span>';
        }
        tr.appendChild(tdCve);

        // Description
        const tdDesc = document.createElement('td');
        const mainLink = r.link ? `<a class="link" href="${r.link}" target="_blank" rel="noopener">${r.title}</a>` : `<span>${r.title}</span>`;
        tdDesc.innerHTML = `<div>${mainLink}</div><div class="muted">${r.description || '(no description)'}</div>`;
        tr.appendChild(tdDesc);

        // KBs
        const tdKb = document.createElement('td');
        if (r.kbs.length){
          tdKb.innerHTML = `<div class="kb-list">` + r.kbs.map(k=>`<span class="kb">${k}</span>`).join('') + `</div>`;
        } else {
          tdKb.innerHTML = '<span class="muted">—</span>';
        }
        tr.appendChild(tdKb);

        // Known issues
        const tdKi = document.createElement('td');
        if (r.knownIssuesUrl){
          tdKi.innerHTML = `<a class="pill link" href="${r.knownIssuesUrl}" target="_blank" rel="noopener">Known issues</a>`;
        } else {
          tdKi.innerHTML = '<span class="muted">—</span>';
        }
        tr.appendChild(tdKi);

        // Date
        const tdDate = document.createElement('td');
        tdDate.className = 'nowrap';
        tdDate.textContent = fmtDate(r.releaseDate);
        tr.appendChild(tdDate);

        // Source
        const tdSrc = document.createElement('td');
        const src = (r.source||'').toUpperCase().includes('RSS') ? 'SUG RSS' :
                    (r.source||'').toUpperCase().includes('JSON') ? 'SUG JSON' :
                    (r.source||'');
        tdSrc.innerHTML = src ? `<span class="pill">${src}</span>` : '<span class="muted">—</span>';
        tr.appendChild(tdSrc);

        tb.appendChild(tr);
      }

      document.getElementById('count').textContent = `${rows.length} update${rows.length===1?'':'s'}`;
    }

    async function load(){
      try{
        const r = await fetch('data.json', {cache:'no-store'});
        const items = normalize(await r.json());
        window._DATA = items;
        render(items);
      }catch(e){
        console.error(e);
        window._DATA = [];
        render([]);
      }
    }

    document.getElementById('q').addEventListener('input', ()=>render(window._DATA||[]));
    document.getElementById('sort').addEventListener('change', ()=>render(window._DATA||[]));
    document.getElementById('print').addEventListener('click', ()=>window.print());
    document.getElementById('email').addEventListener('click', ()=>{
      const url = location.href;
      location.href = `mailto:?subject=Windows Updates (Last 30 Days)&body=${encodeURIComponent(url)}`;
    });

    load();
  </script>
</body>
</html>
