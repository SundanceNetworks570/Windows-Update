<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Windows Updates (Last 30 Days)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a;--bg-elev:#111827;--panel:#0b1220;--text:#e5e7eb;--muted:#9ca3af;
      --accent:#60a5fa;--chip:#1f2937;--good:#10b981;--warn:#f59e0b;--bad:#ef4444;
      --row:#0b1426;--row-alt:#0c162a;--border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 16px;font-size:28px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 18px}
    .toolbar > *{height:40px;border-radius:8px;border:1px solid var(--border);background:var(--panel);color:var(--text)}
    .search{flex:1 1 420px;padding:0 12px;outline:none}
    .select{padding:0 12px;appearance:none;min-width:220px}
    .btn{padding:0 14px;background:#0b1830;border:1px solid var(--border);cursor:pointer}
    .btn:hover{background:#0e203e}
    .meta{color:var(--muted);margin-bottom:8px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    tbody tr{background:var(--row);border:1px solid var(--border)}
    tbody tr:nth-child(even){background:var(--row-alt)}
    th,td{padding:14px 12px;vertical-align:top}
    th{color:var(--muted);font-weight:600;text-align:left}
    .chip{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:var(--chip);color:var(--muted);font-size:12px;margin-top:4px}
    .cve{font-weight:600}
    .badge{display:inline-block;font-size:12px;border-radius:6px;padding:2px 8px;background:#102341;border:1px solid var(--border);margin-left:6px;color:var(--muted)}
    .kb{display:inline-flex;gap:6px;flex-wrap:wrap}
    .kb span{background:#14223b;border:1px solid var(--border);padding:3px 8px;border-radius:6px}
    .link-btn{display:inline-flex;align-items:center;gap:6px;background:#11213a;border:1px solid var(--border);padding:6px 10px;border-radius:8px}
    .empty{color:var(--muted);font-style:italic}
    .foot{color:var(--muted);margin-top:18px;font-size:12px}
    .right{float:right}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Windows Updates (Last 30 Days)</h1>

    <div class="toolbar">
      <input id="q" class="search" type="search" placeholder="Search CVE, KB, description, OS, etc…" />
      <select id="os" class="select" title="Filter by OS">
        <option value="">All operating systems</option>
      </select>
      <select id="sort" class="select" title="Sort">
        <option value="newest">Sort: Newest first</option>
        <option value="oldest">Sort: Oldest first</option>
        <option value="cve">Sort: CVE (A–Z)</option>
      </select>
      <button id="print" class="btn" type="button">Print / PDF</button>
      <button id="email" class="btn" type="button">Email</button>
    </div>

    <div id="count" class="meta"></div>

    <table aria-label="Windows updates from the last 30 days">
      <thead>
        <tr>
          <th style="width:18%">CVE</th>
          <th style="width:34%">Description</th>
          <th style="width:14%">KB(s)</th>
          <th style="width:14%">Known Issues</th>
          <th style="width:12%">Release Date</th>
          <th style="width:8%">Source</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="foot">
      Source: Microsoft Security Response Center (SUG API, CVRF, Release Health / Known-issues).
      <span id="generated" class="right"></span>
    </div>
  </div>

<script>
(async function(){
  const $ = sel => document.querySelector(sel);

  const qEl   = $('#q');
  const osEl  = $('#os');
  const sortEl= $('#sort');
  const rowsEl= $('#rows');
  const countEl = $('#count');
  const genEl   = $('#generated');

  // --- Helpers -------------------------------------------------------------
  const unicodeHyphenRe = /[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g; // normalize to '-'
  function normalizeCve(raw){
    if(!raw) return '';
    return String(raw)
      .toUpperCase()
      .replace(unicodeHyphenRe,'-')
      .replace(/\s+/g,'')
      .trim();
  }
  function isCveId(s){ return /^CVE-\d{4}-\d{4,7}$/.test(s||''); }

  function extractKbs(text){
    if(!text) return [];
    const out = [];
    const re = /\bKB[\s-]?(\d{6,8})\b/gi;
    let m;
    while ((m = re.exec(text))) out.push('KB' + m[1]);
    return [...new Set(out)];
  }

  const parseDate = s => {
    if(!s) return null;
    const d = new Date(s);
    return isNaN(d) ? null : d;
  };
  const fmtDate = d => d ? d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'}) : '—';
  const uniq = arr => [...new Set((arr||[]).filter(Boolean))];

  // --- Load data -----------------------------------------------------------
  let data = [];
  try{
    const res = await fetch('data.json', {cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    data = await res.json();
    if(!Array.isArray(data)) throw new Error('data.json is not an array');
  }catch(e){
    rowsEl.innerHTML = `<tr><td colspan="6" class="empty">Unable to load data.json (${e.message}).</td></tr>`;
    return;
  }

  // --- Normalize -----------------------------------------------------------
  data = data.map(x=>{
    const rawCve = x.cveId ?? x.cve ?? x.id ?? '';
    const cveNorm = normalizeCve(rawCve);
    const cveDisplay = rawCve || 'N/A';

    const desc = (x.description || '').replace(/\s+/g,' ').trim();
    const date = x.releaseDate || x.published || x.date || null;
    const source = (x.source || '').toUpperCase();
    const os = x.os || x.product || '';

    let kb = x.kb || x.kbs || [];
    if (typeof kb === 'string') kb = [kb];
    // Fallback: pull KBs from description if not present
    if (!kb || kb.length === 0) kb = extractKbs(desc);

    const known = x.knownIssuesUrl || x.knownIssue || '';
    const msrc  = x.msrcUrl || x.url || '';

    // Best MSRC link: CVE page if we have a valid CVE; otherwise any provided msrc/url
    const cveHref = isCveId(cveNorm)
      ? `https://msrc.microsoft.com/update-guide/vulnerability/${encodeURIComponent(cveNorm)}`
      : (msrc || '');

    return {
      cveDisplay, cveNorm, cveHref,
      desc, date, source, os,
      kb: uniq(kb), known
    };
  });

  // OS filter options
  const osSet = [...new Set(data.map(d => (d.os||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  if (osSet.length){
    osSet.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      osEl.appendChild(opt);
    });
  } else {
    osEl.style.display = 'none';
  }

  // --- Render --------------------------------------------------------------
  function render(){
    const term = (qEl.value||'').toLowerCase();
    const osFilter = (osEl.value||'').toLowerCase();

    let out = data.filter(d=>{
      const hay = [d.cveDisplay, d.desc, d.os, ...(d.kb||[])].join(' ').toLowerCase();
      const hitQ = !term || hay.includes(term);
      const hitOS = !osFilter || (d.os||'').toLowerCase()===osFilter;
      return hitQ && hitOS;
    });

    // Sort
    const sortBy = sortEl.value;
    out.sort((a,b)=>{
      if (sortBy==='cve') return String(a.cveNorm).localeCompare(String(b.cveNorm));
      const da = parseDate(a.date), db = parseDate(b.date);
      const av = da ? da.getTime() : 0, bv = db ? db.getTime() : 0;
      return (sortBy==='oldest') ? (av-bv) : (bv-av);
    });

    // Rows
    rowsEl.innerHTML = out.map(d=>{
      const dObj = parseDate(d.date);
      const dateStr = fmtDate(dObj);

      const cveHtml = d.cveHref
        ? `<a class="cve" href="${d.cveHref}" target="_blank" rel="noopener">${d.cveDisplay}</a>`
        : `<span class="cve">${d.cveDisplay}</span>`;

      const osHtml = d.os ? ` <span class="chip" title="OS / Product">${d.os}</span>` : '';
      const descHtml = d.desc ? d.desc : `<span class="empty">(no description)</span>`;

      const kbHtml = (d.kb && d.kb.length)
        ? `<div class="kb">${d.kb.map(k=>{
            const clean = String(k).toUpperCase().replace(/^KB/i,'KB').replace(/\s+/g,'').replace(/-/g,'');
            const url = `https://support.microsoft.com/help/${clean.replace(/^KB/i,'')}`;
            return `<span><a href="${url}" target="_blank" rel="noopener">${clean}</a></span>`;
          }).join('')}</div>`
        : `<span class="empty">—</span>`;

      const knownHtml = d.known
        ? `<a class="link-btn" href="${d.known}" target="_blank" rel="noopener">Known issues</a>`
        : `<span class="empty">—</span>`;

      const srcHtml = `<span class="badge" title="Source">${d.source || '—'}</span>`;

      return `
        <tr>
          <td>${cveHtml}${osHtml}</td>
          <td>${descHtml}</td>
          <td>${kbHtml}</td>
          <td>${knownHtml}</td>
          <td>${dateStr}</td>
          <td>${srcHtml}</td>
        </tr>`;
    }).join('');

    countEl.textContent = `${out.length} update${out.length===1?'':'s'}`;
    const newest = out.map(d=>parseDate(d.date)).filter(Boolean).sort((a,b)=>b-a)[0];
    genEl.textContent = newest ? `Latest: ${fmtDate(newest)}` : '';

    if (!out.length){
      rowsEl.innerHTML = `<tr><td colspan="6" class="empty">No updates match your filters.</td></tr>`;
    }
  }

  // Bind UI
  qEl.addEventListener('input', render);
  osEl.addEventListener('change', render);
  sortEl.addEventListener('change', render);
  $('#print').addEventListener('click', ()=> window.print());
  $('#email').addEventListener('click', ()=>{
    const subject = encodeURIComponent('Windows Updates – last 30 days');
    const body = encodeURIComponent('See the latest Windows updates:\n' + window.location.href);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  });

  render();
})();
</script>
</body>
</html>
