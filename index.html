<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Windows Updates (Last 30 Days)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;        /* dark slate */
      --card:#111827;      /* slightly lighter for rows */
      --text:#e5e7eb;      /* gray-200 */
      --muted:#9ca3af;     /* gray-400 */
      --accent:#60a5fa;    /* blue-400 */
      --chip:#1f2937;      /* gray-800 */
      --chipBorder:#374151;/* gray-700 */
      --pill:#0ea5e9;      /* sky-500 */
      --pillText:#032a36;
      --tableSep:#1f2937;
      --btn:#111827;
      --btnBorder:#374151;
      --btnHover:#1f2937;
      --ok:#10b981;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:1200px; margin:48px auto; padding:0 20px}
    h1{margin:0 0 16px; font-size:28px}
    .toolbar{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:16px 0 24px;
    }
    input[type="search"]{
      flex:1; min-width:260px; background:#0b1220; color:var(--text);
      border:1px solid var(--btnBorder); border-radius:10px; padding:12px 14px;
      outline:none;
    }
    select, .btn{
      background:var(--btn); color:var(--text);
      border:1px solid var(--btnBorder); border-radius:10px; padding:10px 14px;
      cursor:pointer;
    }
    .btn:hover{background:var(--btnHover)}
    .table{
      width:100%; border-collapse:separate; border-spacing:0 10px;
    }
    .th{
      display:grid; grid-template-columns: 210px 1fr 160px 140px 140px 110px;
      padding:10px 14px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.04em;
    }
    .row{
      display:grid; grid-template-columns: 210px 1fr 160px 140px 140px 110px;
      background:var(--card);
      border:1px solid var(--tableSep);
      border-radius:12px; padding:16px 14px; align-items:center; gap:12px;
    }
    .row:not(:first-child){margin-top:10px}
    .cve a{color:var(--accent); text-decoration:none}
    .cve a:hover{text-decoration:underline}
    .desc{color:#d1d5db; line-height:1.35}
    .kbs, .cves{display:flex; flex-wrap:wrap; gap:6px}
    .chip{
      background:var(--chip); border:1px solid var(--chipBorder); color:#e5e7eb;
      border-radius:999px; padding:6px 10px; font-size:12px; text-decoration:none;
    }
    .chip:hover{border-color:#4b5563}
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:98px; height:34px; padding:0 10px;
      background:var(--pill); color:#eaf7ff; border:none; border-radius:999px;
      font-weight:600; cursor:pointer; text-decoration:none;
    }
    .pill[disabled]{opacity:.35; cursor:default}
    .src{font-size:12px; color:var(--muted)}
    .footer{margin:28px 0 10px; color:var(--muted); font-size:12px}
    .empty{padding:38px; text-align:center; color:var(--muted)}
    .count{color:var(--muted); font-size:13px; margin-bottom:10px}
    @media (max-width:980px){
      .th, .row{
        grid-template-columns: 190px 1fr 150px 140px 130px 100px;
      }
    }
    @media (max-width:860px){
      .th{display:none}
      .row{grid-template-columns: 1fr}
      .row > div{padding:6px 0}
      .label{display:block; font-size:11px; color:var(--muted); margin-bottom:4px; text-transform:uppercase; letter-spacing:.04em}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Windows Updates (Last 30 Days)</h1>

    <div class="toolbar">
      <input id="q" type="search" placeholder="Search CVE, KB, description, OS, etc…" autocomplete="off">
      <select id="sort">
        <option value="new">Sort: Newest first</option>
        <option value="old">Sort: Oldest first</option>
      </select>
      <button class="btn" id="printBtn" title="Print / Save PDF">Print / PDF</button>
      <button class="btn" id="emailBtn" title="Compose email with table link">Email</button>
    </div>

    <div id="count" class="count"></div>

    <div class="th">
      <div>CVE</div>
      <div>Description</div>
      <div>KB(s)</div>
      <div>Known Issues</div>
      <div>Release Date</div>
      <div>Source</div>
    </div>
    <div id="rows"></div>

    <div class="footer">
      Source: Microsoft Security Response Center (MSRC RSS) and Windows Release Health (Known issues / KB discovery).
    </div>
  </div>

  <script>
    // ---- Small helpers
    const byId = id => document.getElementById(id);
    const catalogLink = kb => `https://www.catalog.update.microsoft.com/Search.aspx?q=${encodeURIComponent(kb)}`;
    const msrcCveLink  = cve => `https://msrc.microsoft.com/update-guide/vulnerability/${encodeURIComponent(cve)}`;
    const isCve = s => /^CVE-\d{4}-\d{4,7}$/i.test(s || '');
    const kbify = s => s.toUpperCase().startsWith('KB') ? s.toUpperCase() : ('KB' + s);

    // ---- Runtime state
    let DATA = [];
    let filtered = [];

    // ---- Fetch & render
    async function load() {
      try {
        const r = await fetch('data.json?' + Date.now(), {cache:'no-store'});
        if (!r.ok) throw new Error('HTTP ' + r.status);
        DATA = await r.json();
      } catch (e) {
        console.error('Failed to load data.json', e);
        DATA = [];
      }
      // normalize arrays and strings we rely on
      for (const it of DATA) {
        it.cves = Array.isArray(it.cves) ? it.cves : (it.cve ? String(it.cve).split(/\s*,\s*/) : []);
        it.kbs  = Array.isArray(it.kbs)  ? it.kbs  : (it.kb  ? String(it.kb ).split(/\s*,\s*/) : []);
        it.kbs = it.kbs.map(k => kbify(String(k).replace(/^KB/i,'')));
        // prefer knownIssuesUrl, but accept "knownIssues" for back-compat
        it.knownIssuesUrl = it.knownIssuesUrl || it.knownIssues || '';
      }
      apply();
    }

    function apply() {
      const q = byId('q').value.trim().toLowerCase();
      const sort = byId('sort').value;

      filtered = DATA.filter(it => {
        if (!q) return true;
        const hay = [
          ...(it.cves||[]).join(' '),
          ...(it.kbs||[]).join(' '),
          it.title||'',
          it.description||'',
          it.source||'',
          it.link||'',
          it.releaseDate||''
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });

      filtered.sort((a,b) => {
        const da = Date.parse(a.releaseDate||'') || 0;
        const db = Date.parse(b.releaseDate||'') || 0;
        return sort === 'new' ? db - da : da - db;
      });

      render();
    }

    function render() {
      const root = byId('rows');
      root.innerHTML = '';

      if (!filtered.length) {
        const d = document.createElement('div');
        d.className = 'empty';
        d.textContent = 'No updates match your filters.';
        root.appendChild(d);
        byId('count').textContent = '';
        return;
      }

      byId('count').textContent = `${filtered.length} update${filtered.length!==1?'s':''}`;

      for (const it of filtered) {
        const row = document.createElement('div');
        row.className = 'row';

        // CVE column
        const cveCol = document.createElement('div');
        cveCol.className = 'cve';
        if (Array.isArray(it.cves) && it.cves.length) {
          const wrap = document.createElement('div');
          wrap.className = 'cves';
          it.cves.forEach(cve => {
            if (!isCve(cve)) return;
            const a = document.createElement('a');
            a.className = 'chip';
            a.href = msrcCveLink(cve);
            a.target = '_blank';
            a.rel = 'noopener';
            a.textContent = cve.toUpperCase();
            wrap.appendChild(a);
          });
          cveCol.appendChild(wrap);
        } else {
          cveCol.innerHTML = '<span class="muted">N/A</span>';
        }

        // Description
        const descCol = document.createElement('div');
        descCol.className = 'desc';
        const title = it.title || '';
        const p = document.createElement('div');
        p.innerHTML = escapeHtml(title || '(no title)');
        if (it.link) {
          const a = document.createElement('a');
          a.href = it.link;
          a.target = '_blank';
          a.rel = 'noopener';
          a.style.display = 'inline-block';
          a.style.color = '#93c5fd';
          a.style.textDecoration = 'none';
          a.textContent = '  link';
          p.appendChild(a);
        }
        const d2 = document.createElement('div');
        d2.style.marginTop = '6px';
        d2.style.fontSize = '13px';
        d2.style.color = '#cbd5e1';
        d2.textContent = stripHtml(it.description || '(no description)');
        descCol.appendChild(p);
        descCol.appendChild(d2);

        // KB(s)
        const kbCol = document.createElement('div');
        const kbWrap = document.createElement('div');
        kbWrap.className = 'kbs';
        if (Array.isArray(it.kbs) && it.kbs.length) {
          it.kbs.forEach(kb => {
            const a = document.createElement('a');
            a.className = 'chip';
            a.href = catalogLink(kb);
            a.target = '_blank';
            a.rel = 'noopener';
            a.textContent = kb.toUpperCase();
            kbWrap.appendChild(a);
          });
        } else {
          const s = document.createElement('span');
          s.style.color = '#9ca3af';
          s.textContent = '—';
          kbWrap.appendChild(s);
        }
        kbCol.appendChild(kbWrap);

        // Known Issues
        const kiCol = document.createElement('div');
        if (it.knownIssuesUrl) {
          const a = document.createElement('a');
          a.href = it.knownIssuesUrl;
          a.target = '_blank';
          a.rel = 'noopener';
          a.className = 'pill';
          a.textContent = 'Known issues';
          kiCol.appendChild(a);
        } else {
          const s = document.createElement('span');
          s.style.color = '#9ca3af';
          s.textContent = '—';
          kiCol.appendChild(s);
        }

        // Date
        const dateCol = document.createElement('div');
        dateCol.textContent = fmtDate(it.releaseDate);

        // Source
        const srcCol = document.createElement('div');
        srcCol.className = 'src';
        srcCol.textContent = (it.source || '').toString();

        // When stacked (mobile), add labels
        if (window.matchMedia('(max-width: 860px)').matches) {
          cveCol.prepend(label('CVE'));
          descCol.prepend(label('Description'));
          kbCol.prepend(label('KB(s)'));
          kiCol.prepend(label('Known Issues'));
          dateCol.prepend(label('Release Date'));
          srcCol.prepend(label('Source'));
        }

        row.appendChild(cveCol);
        row.appendChild(descCol);
        row.appendChild(kbCol);
        row.appendChild(kiCol);
        row.appendChild(dateCol);
        row.appendChild(srcCol);

        root.appendChild(row);
      }
    }

    // ---- Utils
    function label(t){
      const s=document.createElement('span'); s.className='label'; s.textContent=t; return s;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
    function stripHtml(s){ const d=document.createElement('div'); d.innerHTML=s; return d.textContent||d.innerText||''; }
    function fmtDate(s){
      const t = Date.parse(s||'');
      if (!t) return s||'';
      const d = new Date(t);
      return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
    }

    // ---- Events
    byId('q').addEventListener('input', apply);
    byId('sort').addEventListener('change', apply);
    byId('printBtn').addEventListener('click', ()=>window.print());
    byId('emailBtn').addEventListener('click', ()=>{
      const link = location.href;
      const subject = encodeURIComponent('Windows Updates (Last 30 Days)');
      const body = encodeURIComponent(`Here is the current Windows update list:\n\n${link}\n`);
      location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    load();
  </script>
</body>
</html>
