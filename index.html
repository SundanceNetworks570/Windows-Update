<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Windows Updates (Last 30 Days)</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --panel:#111827;     /* gray-900 */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200 */
      --accent:#60a5fa;    /* blue-400 */
      --accent-2:#22d3ee;  /* cyan-400 */
      --ok:#22c55e;        /* green-500 */
      --warn:#f59e0b;      /* amber-500 */
      --bad:#ef4444;       /* red-500 */
      --border:#1f2937;    /* gray-800 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      line-height:1.45;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:28px 20px 64px;}
    h1{margin:0 0 16px;font-size:28px}
    .toolbar{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0 18px;
    }
    .toolbar .group{display:flex; gap:10px; flex:1 1 260px}
    input,select,button{
      background:#0b1220;color:var(--text);border:1px solid var(--border);
      padding:10px 12px;border-radius:10px;outline:none;font-size:14px;
    }
    input::placeholder{color:var(--muted)}
    select{cursor:pointer}
    button{cursor:pointer;border-color:#1e293b}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#001b2b;border:none}
    button.ghost{background:#0b1220}
    .pill{font-size:12px;color:var(--muted)}
    .status{margin:18px 0;padding:14px;border:1px dashed var(--border);border-radius:12px;background:#0b1220}
    .status.bad{border-color:#3f1f1f}
    .status .title{font-weight:600;margin-bottom:6px}
    table{width:100%;border-collapse:collapse;background:#0b1220;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    thead th{
      text-align:left;font-weight:600;font-size:13px;color:#cbd5e1;background:#0a101d;
      border-bottom:1px solid var(--border);padding:12px;
    }
    tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:hover{background:#0e1629}
    .cve{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px}
    .badge{
      display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#0a101d;color:#cbd5e1;border:1px solid var(--border)
    }
    footer{margin-top:26px;color:var(--muted);font-size:13px}
    .hide{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Windows Updates (Last 30 Days)</h1>

    <div class="toolbar">
      <div class="group" style="flex:3 1 420px">
        <input id="q" placeholder="Search CVE, description, source, URL…" />
        <select id="os">
          <option value="">All operating systems</option>
        </select>
        <select id="sort">
          <option value="new">Sort: Newest first</option>
          <option value="old">Sort: Oldest first</option>
          <option value="cve">Sort: CVE (A→Z)</option>
        </select>
      </div>
      <div class="right">
        <button id="print" class="ghost">Print / PDF</button>
        <button id="email" class="primary">Email</button>
      </div>
    </div>

    <div id="status" class="status hide">
      <div class="title">Couldn’t load data.</div>
      <div class="muted">
        If this is your first deploy and <code>data.json</code> doesn’t exist yet, run
        <strong>Build MSRC updates JSON (daily)</strong> from the repo’s <em>Actions</em> tab, then refresh this page.
      </div>
    </div>

    <div id="summary" class="pill muted"></div>

    <table id="tbl" class="hide" aria-label="Windows updates">
      <thead>
        <tr>
          <th style="width:18%">CVE</th>
          <th>Description</th>
          <th style="width:18%">Release date</th>
          <th style="width:18%">Source</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <footer>
      <div class="muted">
        Source: Microsoft Security Response Center CVRF API v3; Windows Release Health pages for known-issues links.
      </div>
    </footer>
  </div>

  <script>
    // ----------------------- Safe date helpers (no crashes) -----------------------
    function safeDate(value){
      if (!value) return null;
      const t = Date.parse(value);
      return Number.isNaN(t) ? null : new Date(t);
    }
    function safeISO(value){
      const d = safeDate(value);
      try { return d ? d.toISOString() : null; } catch { return null; }
    }
    function safeLocal(value, locale = navigator.language, opts = {year:'numeric',month:'short',day:'2-digit'}){
      const d = safeDate(value);
      try { return d ? d.toLocaleDateString(locale, opts) : 'Unknown'; } catch { return 'Unknown'; }
    }
    function cmpByDateDesc(a,b,key='releaseDate'){
      const da = safeDate(a[key]); const db = safeDate(b[key]);
      if (!da && !db) return 0; if (!da) return 1; if (!db) return -1;
      return db - da;
    }
    function cmpByDateAsc(a,b,key='releaseDate'){ return -cmpByDateDesc(a,b,key); }

    // ----------------------- DOM bits -----------------------
    const els = {
      status: document.getElementById('status'),
      table : document.getElementById('tbl'),
      rows  : document.getElementById('rows'),
      q     : document.getElementById('q'),
      os    : document.getElementById('os'),
      sort  : document.getElementById('sort'),
      print : document.getElementById('print'),
      email : document.getElementById('email'),
      summary: document.getElementById('summary'),
    };

    const state = {
      all: [],
      filtered: [],
    };

    // ----------------------- Render functions -----------------------
    function renderRows(list){
      els.rows.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const it of list){
        const tr = document.createElement('tr');

        const tdCVE = document.createElement('td');
        tdCVE.innerHTML = it.url
          ? `<a class="cve" href="${it.url}" target="_blank" rel="noopener">${escapeHTML(it.cve || '—')}</a>`
          : `<span class="cve">${escapeHTML(it.cve || '—')}</span>`;
        tr.appendChild(tdCVE);

        const tdDesc = document.createElement('td');
        const desc = it.description || it.title || '';
        tdDesc.innerHTML = `
          <div>${escapeHTML(desc || '(no description)')}</div>
          <div class="muted" style="margin-top:6px;font-size:12px;word-break:break-word;">
            ${it.url ? `<span class="badge">link</span> ${escapeHTML(it.url)}` : ''}
            ${it.os ? `&nbsp;&nbsp;<span class="badge">os</span> ${escapeHTML(it.os)}` : ''}
            ${it.severity ? `&nbsp;&nbsp;<span class="badge">severity</span> ${escapeHTML(it.severity)}` : ''}
          </div>
        `;
        tr.appendChild(tdDesc);

        const tdDate = document.createElement('td');
        const d = safeLocal(it.releaseDate);
        tdDate.textContent = d;
        tr.appendChild(tdDate);

        const tdSource = document.createElement('td');
        tdSource.textContent = it.source || '—';
        tr.appendChild(tdSource);

        frag.appendChild(tr);
      }
      els.rows.appendChild(frag);
      els.table.classList.toggle('hide', list.length === 0);
      els.summary.textContent = list.length
        ? `${list.length.toLocaleString()} update${list.length===1?'':'s'}`
        : '';
    }

    function applyFilters(){
      const q = els.q.value.trim().toLowerCase();
      const os = els.os.value;
      let list = state.all.slice();

      if (os){
        list = list.filter(x => (x.os || '').toLowerCase().includes(os.toLowerCase()));
      }
      if (q){
        list = list.filter(x => {
          return [x.cve, x.description, x.title, x.source, x.url, x.os]
            .filter(Boolean)
            .some(v => String(v).toLowerCase().includes(q));
        });
      }

      switch (els.sort.value){
        case 'old': list.sort((a,b)=>cmpByDateAsc(a,b,'releaseDate')); break;
        case 'cve': list.sort((a,b)=>String(a.cve||'').localeCompare(String(b.cve||''))); break;
        default:    list.sort((a,b)=>cmpByDateDesc(a,b,'releaseDate')); break;
      }

      state.filtered = list;
      renderRows(list);
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // ----------------------- Load + initialize -----------------------
    (async function init(){
      try{
        const resp = await fetch('./data.json', {cache:'no-store'});
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const raw = await resp.json();

        if (!Array.isArray(raw) || raw.length===0){
          throw new Error('Empty data.json');
        }

        // Normalize fields we actually use; keep others intact
        const normalized = raw.map(x => ({
          cve: x.cve || x.CVE || x.id || '',
          url: x.url || x.link || '',
          description: x.description || x.desc || '',
          title: x.title || '',
          releaseDate: x.releaseDate || x.released || x.date || '',
          source: x.source || '',
          os: x.os || x.product || x.platform || '',
          severity: x.severity || x.cvssSeverity || '',
        }));

        // Build OS filter options if present in any rows
        const osSet = new Set(
          normalized
            .map(x => (x.os || '').trim())
            .filter(Boolean)
        );
        if (osSet.size > 0){
          for (const name of Array.from(osSet).sort()){
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            els.os.appendChild(opt);
          }
        } else {
          // Hide if no OS info available
          els.os.classList.add('hide');
        }

        // Sort newest first initially
        normalized.sort((a,b)=>cmpByDateDesc(a,b,'releaseDate'));

        state.all = normalized;
        applyFilters();

        els.status.classList.add('hide');
        els.table.classList.remove('hide');

      } catch(err){
        console.error('Load error:', err);
        els.status.classList.remove('hide');
        els.status.classList.add('bad');
        els.table.classList.add('hide');
      }
    })();

    // ----------------------- UI wiring -----------------------
    els.q.addEventListener('input', debounce(applyFilters, 120));
    els.os.addEventListener('change', applyFilters);
    els.sort.addEventListener('change', applyFilters);
    els.print.addEventListener('click', () => window.print());
    els.email.addEventListener('click', () => {
      const subject = encodeURIComponent('Windows Updates (Last 30 Days)');
      const body = encodeURIComponent(`Hi,

Here are the latest Windows updates from the last 30 days.
Total items currently shown: ${state.filtered.length}

View: ${location.href}

— Sent from the Windows Updates page`);
      location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    // small utility
    function debounce(fn, wait=120){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }
  </script>
</body>
</html>
