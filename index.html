<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Windows Updates (Last 30 Days)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --panel:#111827;     /* gray-900 */
      --muted:#9ca3af;     /* gray-400 */
      --text:#e5e7eb;      /* gray-200 */
      --accent:#60a5fa;    /* blue-400 */
      --accent-2:#34d399;  /* emerald-400 */
      --chip:#1f2937;      /* gray-800 */
      --chip-b:#374151;    /* gray-700 */
      --danger:#f87171;    /* red-400 */
      --warn:#f59e0b;      /* amber-500 */
      --ok:#22c55e;        /* green-500 */
      --link:#93c5fd;
      --row:#0b1222;
      --row-alt:#0b1428;
      --border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),#0b1120 40%, #0a0f1d 100%);
      color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      letter-spacing:0.1px;
    }
    .wrap{max-width:1080px; margin:40px auto; padding:0 20px}
    h1{
      margin:0 0 18px;
      font-size:28px;
      font-weight:700;
    }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:16px;
    }
    input[type="search"], select, button{
      background:#0b1324;
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    input[type="search"]{ flex:1 1 380px; }
    select{ min-width:220px }
    .btn{
      cursor:pointer; user-select:none; border:1px solid #1e293b;
      background:#0b1630;
      transition:.15s ease;
    }
    .btn:hover{ transform:translateY(-1px); border-color:#2b3a52 }
    .btn-primary{ background:#0b1d3c; border-color:#243b6b }
    .btn-primary:hover{ background:#0e2349 }
    .table{
      width:100%; border-collapse:separate; border-spacing:0 10px;
    }
    .thead { display:none } /* visually minimalist; we render headers as labels in rows for mobile */
    .row{
      background:linear-gradient(180deg,var(--row),var(--row-alt));
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      display:grid;
      grid-template-columns: 210px 1fr 170px 150px 110px;
      gap:12px;
      align-items:start;
    }
    .row + .row{ margin-top:10px }
    .label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em; }
    .cve a{ color:var(--link); text-decoration:none; font-weight:600 }
    .desc{ color:#d9e3f0; line-height:1.45 }
    .muted{ color:var(--muted) }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:12px;
      background:var(--chip); border:1px solid var(--chip-b); color:#dbeafe;
      text-decoration:none;
    }
    .pill.warn{ color:#fff; background:#2b1a02; border-color:#3a260a }
    .pill.good{ color:#d1fae5; background:#052e26; border-color:#0b4a3b }
    .kb{
      display:inline-flex; align-items:center; gap:6px;
      background:#101a2e; border:1px solid #24314a; color:#c7d2fe;
      padding:4px 8px; border-radius:8px; text-decoration:none; margin:3px 6px 0 0; white-space:nowrap;
      font-size:12px;
    }
    .mono{ font-variant-numeric:tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right{ text-align:right }
    .tiny{ font-size:12px }
    .grid-col{ display:flex; flex-direction:column; gap:8px }
    .bad{ color:var(--danger) }
    .toolbar{ display:flex; gap:8px; margin-left:auto }
    .footer{ margin:26px 0 40px; color:var(--muted); font-size:12px }
    .no-results{ padding:40px; text-align:center; border:1px dashed #334155; border-radius:12px; background:#0b1324 }
    @media (max-width: 980px){
      .row{ grid-template-columns: 1fr; }
      .right{ text-align:left }
      .toolbar{ margin-left:0 }
    }
    a[href]{ color:#a5b4fc }
    a[href]:hover{ text-decoration:underline }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Windows Updates (Last 30 Days)</h1>

    <div class="controls">
      <input id="search" type="search" placeholder="Search CVE, description, OS, KB, severity …" aria-label="Search" />
      <select id="osFilter" aria-label="Filter by operating system">
        <option value="all">All operating systems</option>
      </select>
      <select id="sort" aria-label="Sort">
        <option value="new">Sort: Newest first</option>
        <option value="old">Sort: Oldest first</option>
      </select>
      <div class="toolbar">
        <button class="btn" id="resetBtn" title="Clear filters">Reset</button>
        <button class="btn btn-primary" id="printBtn" title="Print / Save PDF">Print / PDF</button>
      </div>
    </div>

    <div id="count" class="muted tiny" aria-live="polite"></div>

    <div id="list" role="list" aria-busy="true"></div>

    <div class="footer">
      Source: Microsoft Security Response Center (MSRC) APIs &amp; CVRF, plus Windows Release Health for known issues links.
    </div>
  </div>

  <script>
  // -------- Utilities ---------------------------------------------------------
  const $ = sel => document.querySelector(sel);
  const listEl = $('#list');
  const searchEl = $('#search');
  const sortEl = $('#sort');
  const osEl = $('#osFilter');
  const countEl = $('#count');
  const resetBtn = $('#resetBtn');
  const printBtn = $('#printBtn');

  const isStr = v => typeof v === 'string';
  const toDate = v => v ? new Date(v) : null;

  // Normalize “KB5047962” or “5047962” -> { id: "KB5047962", num: "5047962", url: "https://support.microsoft.com/help/5047962" }
  function normalizeKB(kb){
    if(!kb) return null;
    let s = String(kb).trim().toUpperCase();
    let num = (s.startsWith('KB') ? s.slice(2) : s).replace(/[^0-9]/g, '');
    if(!num) return null;
    return { id: 'KB'+num, num, url: `https://support.microsoft.com/help/${num}` };
  }

  // Turn markdown links [text](url) into <a>
  function mdLinksToHtml(text){
    if(!isStr(text)) return '';
    return text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, `<a href="$2" target="_blank" rel="noopener">$1</a>`);
  }

  // Prefer best link for “details” — MSRC update page (msLink), CVE page, or SUG link.
  function bestDetailsUrl(x){
    if(isStr(x.msLink)) return x.msLink;
    if(isStr(x.sourceUrl)) return x.sourceUrl;
    if(isStr(x.cveId) && /^CVE-\d{4}-\d+/i.test(x.cveId)) {
      return `https://msrc.microsoft.com/update-guide/vulnerability/${x.cveId}`;
    }
    return null;
  }

  // Friendly OS names: attempt to map affected product/OS strings.
  function inferOS(x){
    const c = (x.affectedProduct || x.product || x.os || '').toString();
    if(/server/i.test(c)) return 'Windows Server';
    if(/11|23H2|22H2|21H2/i.test(c)) return 'Windows 11';
    if(/10/i.test(c)) return 'Windows 10';
    if(/7|8\./i.test(c)) return 'Legacy';
    return c || 'Unknown';
  }

  // Render a single entry row
  function renderRow(x){
    const cve = x.cveId || x.cve || 'N/A';
    const dateStr = (x.releaseDate || x.published || x.date || '').toString();
    const releaseDate = dateStr ? new Date(dateStr) : null;
    const releaseOut = releaseDate ? releaseDate.toLocaleDateString(undefined,{month:'short', day:'2-digit', year:'numeric'}) : '—';

    // KBs can be array or string
    let kbHtml = '—';
    let kbs = Array.isArray(x.kb) ? x.kb : (x.kb ? [x.kb] : []);
    const kbLinks = [];
    for(const kb of kbs){
      const norm = normalizeKB(kb);
      if(norm){
        kbLinks.push(`<a class="kb mono" href="${norm.url}" target="_blank" rel="noopener" title="Open ${norm.id} on support.microsoft.com">${norm.id}</a>`);
      }
    }
    if(kbLinks.length) kbHtml = kbLinks.join('');

    // Known issues
    let kiHtml = '—';
    if(isStr(x.knownIssuesUrl)){
      kiHtml = `<a class="pill warn" href="${x.knownIssuesUrl}" target="_blank" rel="noopener" title="Open Windows Release Health known issues">Known issues</a>`;
    }

    // Details (MSRC update page preferred)
    const detailsUrl = bestDetailsUrl(x);
    const cveCell = detailsUrl
      ? `<a href="${detailsUrl}" class="mono" target="_blank" rel="noopener">${cve}</a>`
      : `<span class="mono">${cve}</span>`;

    // Description
    const desc = mdLinksToHtml(x.description || x.title || '(no description)');

    // Source chip
    const source = (x.source || '').toString().toUpperCase() || 'MSRC';
    const sourceLink = detailsUrl || x.sourceUrl || '#';
    const sourceHtml = `<a class="pill" href="${sourceLink}" target="_blank" rel="noopener">${source}</a>`;

    return `
      <div class="row" role="listitem">
        <div class="grid-col">
          <div class="label">CVE</div>
          <div class="cve">${cveCell}</div>
        </div>
        <div class="grid-col">
          <div class="label">Description</div>
          <div class="desc">${desc}</div>
        </div>
        <div class="grid-col right">
          <div class="label">KB</div>
          <div>${kbHtml}</div>
        </div>
        <div class="grid-col right">
          <div class="label">Release date</div>
          <div class="mono">${releaseOut}</div>
        </div>
        <div class="grid-col right">
          <div class="label">Known issues</div>
          <div>${kiHtml}</div>
          <div class="label" style="margin-top:6px;">Source</div>
          <div>${sourceHtml}</div>
        </div>
      </div>
    `;
  }

  // -------- Data load + state --------------------------------------------------
  let DATA = [];
  let VIEW = [];
  let ALL_OSES = new Set();

  function normalizeItem(raw){
    // Keep field names flexible to match your workflow’s data.json
    const obj = {
      cveId: raw.cveId || raw.cve || raw.CVE || '',
      title: raw.title || '',
      description: raw.description || raw.desc || '',
      source: raw.source || raw.Source || '',
      sourceUrl: raw.sugUrl || raw.url || raw.sourceUrl || '',
      msLink: raw.msLink || raw.msrcUrl || '',
      kb: raw.kb || raw.kbs || [],
      knownIssuesUrl: raw.knownIssuesUrl || raw.knownIssues || '',
      affectedProduct: raw.affectedProduct || raw.product || raw.os || '',
      releaseDate: raw.releaseDate || raw.date || raw.published || '',
    };
    obj.os = inferOS(obj);
    // Coerce kb to array
    if(isStr(obj.kb)) obj.kb = [obj.kb];
    return obj;
  }

  async function load(){
    try{
      const resp = await fetch('data.json', {cache:'no-store'});
      const json = await resp.json();
      DATA = Array.isArray(json) ? json.map(normalizeItem) : [];
      // OS options
      DATA.forEach(x => { if(x.os && x.os !== 'Unknown') ALL_OSES.add(x.os) });
      renderOsOptions();
      apply();
    }catch(e){
      listEl.innerHTML = `<div class="no-results bad">Failed to load <code>data.json</code>. ${e}</div>`;
    }
  }

  function renderOsOptions(){
    const items = Array.from(ALL_OSES).sort((a,b)=>a.localeCompare(b,'en',{numeric:true}));
    osEl.innerHTML = `<option value="all">All operating systems</option>` + items.map(v=>`<option value="${v}">${v}</option>`).join('');
  }

  // -------- Filtering / sorting / rendering -----------------------------------
  function apply(){
    const q = searchEl.value.trim().toLowerCase();
    const os = osEl.value;
    const sort = sortEl.value;

    VIEW = DATA.filter(x=>{
      if(os !== 'all' && x.os !== os) return false;
      if(!q) return true;
      const hay = [
        x.cveId, x.title, x.description, x.os,
        ...(Array.isArray(x.kb) ? x.kb : [])
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });

    VIEW.sort((a,b)=>{
      const da = toDate(a.releaseDate)?.getTime() ?? 0;
      const db = toDate(b.releaseDate)?.getTime() ?? 0;
      return sort === 'new' ? db - da : da - db;
    });

    render();
  }

  function render(){
    countEl.textContent = `${VIEW.length.toLocaleString()} updates`;
    if(!VIEW.length){
      listEl.innerHTML = `<div class="no-results">No results match your filters.</div>`;
      return;
    }
    // Build all rows
    listEl.innerHTML = VIEW.map(renderRow).join('');
  }

  // -------- Events -------------------------------------------------------------
  let t;
  searchEl.addEventListener('input', ()=>{ clearTimeout(t); t = setTimeout(apply, 150) });
  osEl.addEventListener('change', apply);
  sortEl.addEventListener('change', apply);
  resetBtn.addEventListener('click', ()=>{
    searchEl.value = '';
    osEl.value = 'all';
    sortEl.value = 'new';
    apply();
  });
  printBtn.addEventListener('click', ()=>window.print());

  // Load
  load();
  </script>
</body>
</html>
