<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Windows Updates (Last 30 Days)</title>
  <link rel="preconnect" href="https://api.msrc.microsoft.com">
  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#38bdf8;--accent-2:#22d3ee;--good:#22c55e;
      --row:#0b1220;--row-alt:#0d1526;--chip:#0b2239;--chip-border:#11304d;--pill:#0b2a3d
    }
    html,body{background:#0b1220;color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    h1{font-weight:800;letter-spacing:.2px;margin:0 0 14px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 18px}
    .search{flex:1;min-width:260px}
    input,select,button{border-radius:10px;border:1px solid #22314a;background:#0b1b30;color:var(--text);padding:10px 12px}
    input::placeholder{color:#6b7280}
    button{background:linear-gradient(135deg,var(--accent),var(--accent-2));border:none;color:#08111f;font-weight:700;cursor:pointer}
    .btn{padding:10px 14px}
    .muted{color:var(--muted)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table thead th{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#9aa5b1;text-align:left;padding:0 12px}
    .row{background:linear-gradient(180deg,#0e1726 0%,#0a1322 100%); border:1px solid #15263f; box-shadow:0 6px 16px rgba(0,0,0,.35);
         border-radius:12px}
    .cell{padding:12px}
    .badge{display:inline-block;background:var(--chip);border:1px solid var(--chip-border);padding:3px 8px;border-radius:999px;font-size:12px}
    .link{color:#80d4ff;text-decoration:none}
    .link:hover{text-decoration:underline}
    .subtle{font-size:12px;color:#8aa0b5}
    .pill{display:inline-block;font-size:12px;padding:6px 10px;border:1px solid #1f3d5a;background:#0b1d2c;border-radius:999px}
    .status{display:flex;align-items:center;gap:8px;margin-top:8px}
    .ok{color:var(--good)}
    .error{color:#f87171}
    .hidden{display:none}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .right{display:flex;gap:8px}
    .narrow{max-width:620px}
    .foot{margin:26px 0 10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Windows Updates (Last 30 Days)</h1>
      <div class="right">
        <button class="btn" id="printBtn">Print / PDF</button>
        <button class="btn" id="emailBtn">Email</button>
      </div>
    </div>

    <div class="toolbar">
      <input id="q" class="search" type="search" placeholder="Search CVE, description, OS, severity …" />
      <select id="os">
        <option value="">All operating systems</option>
        <option>Windows 10</option>
        <option>Windows 11</option>
        <option>Windows Server</option>
      </select>
      <select id="sort">
        <option value="new">Sort: Newest first</option>
        <option value="old">Sort: Oldest first</option>
        <option value="cve">Sort: CVE</option>
      </select>
    </div>

    <div id="counter" class="muted">Loading…</div>

    <table class="table" id="tbl">
      <thead>
        <tr>
          <th style="width:22%">CVE</th>
          <th style="width:48%">Description</th>
          <th style="width:18%">Release date</th>
          <th style="width:12%">Source</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div id="empty" class="narrow muted hidden">
      <p><strong>Couldn’t load data.</strong></p>
      <p>If this is your first deploy and <code class="mono">data.json</code> doesn’t exist yet,
         open the repo’s <em>Actions</em> tab and run <em>Build MSRC updates JSON (daily)</em> once.</p>
    </div>

    <div class="foot muted">
      <div>Source: Microsoft Security Response Center CVRF v3; Windows Release Health pages for known-issues links.</div>
    </div>
  </div>

<script>
(async function () {
  const $ = (sel) => document.querySelector(sel);
  const tbody = $('#tbody');
  const counter = $('#counter');
  const empty = $('#empty');

  const fmtDate = (iso) => {
    try {
      if (!iso) return '';
      const d = new Date(iso + 'T00:00:00Z');
      return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' });
    } catch { return iso; }
  };

  // --- Load base entries (CVE, url, releaseDate, source) ---
  let entries = [];
  try {
    const r = await fetch('./data.json', { cache:'no-store' });
    if (!r.ok) throw new Error('data.json not found');
    entries = await r.json();
  } catch (e) {
    console.error(e);
    counter.textContent = 'Couldn’t load data.';
    empty.classList.remove('hidden');
    return;
  }

  // --- Build a month tag → CVE -> description map from CVRF XML (few requests) ---
  const byMonth = {};
  for (const e of entries) {
    if (!e.source) continue;
    (byMonth[e.source] ??= []).push(e.cve);
  }

  const cvrfDescMap = new Map(); // CVE -> description/title
  const monthKeys = Object.keys(byMonth);

  for (const m of monthKeys) {
    // m already like "2025-Oct"
    const url = `https://api.msrc.microsoft.com/cvrf/v3.0/${encodeURIComponent(m)}`;
    try {
      const res = await fetch(url, { cache:'force-cache' });
      if (!res.ok) {
        console.warn('CVRF fetch failed', m, res.status);
        continue;
      }
      const text = await res.text();
      const doc = new DOMParser().parseFromString(text, 'application/xml');

      const getNS = (node, localName) => node.getElementsByTagNameNS('*', localName);

      const vulns = getNS(doc, 'Vulnerability');
      for (const v of vulns) {
        // CVE id can appear in different places; grab any <CVE> or <ID> with CVE- prefix.
        let cve = '';
        const cveNode = getNS(v, 'CVE')[0] || null;
        if (cveNode && cveNode.textContent) {
          cve = cveNode.textContent.trim();
        } else {
          const idNode = getNS(v, 'ID')[0] || null;
          const t = idNode?.textContent?.trim() || '';
          if (/^CVE-\d{4}-\d+/i.test(t)) cve = t;
        }
        if (!cve) continue;

        // Prefer a Note of Type="Description", else Title
        let desc = '';
        const notes = getNS(v, 'Note');
        for (const n of notes) {
          const t = (n.getAttribute('Type') || n.getAttribute('type') || '').toLowerCase();
          if (t === 'description') {
            desc = n.textContent.trim();
            break;
          }
        }
        if (!desc) {
          const title = getNS(v, 'Title')[0];
          if (title) desc = title.textContent.trim();
        }
        if (desc) cvrfDescMap.set(cve.toUpperCase(), desc);
      }
    } catch (err) {
      console.warn('CVRF parse error', m, err);
    }
  }

  // Attach description from map (fallback to empty string)
  for (const e of entries) {
    const fromCvrf = cvrfDescMap.get((e.cve || '').toUpperCase());
    if (fromCvrf && !e.description) e.description = fromCvrf;
  }

  // --- UI state & rendering ---
  const state = {
    q: '',
    os: '',
    sort: 'new'
  };

  $('#q').addEventListener('input', (ev) => { state.q = ev.target.value.trim().toLowerCase(); render(); });
  $('#os').addEventListener('change', (ev) => { state.os = ev.target.value; render(); });
  $('#sort').addEventListener('change', (ev) => { state.sort = ev.target.value; render(); });
  $('#printBtn').addEventListener('click', () => window.print());
  $('#emailBtn').addEventListener('click', () => {
    const url = location.href;
    const body = encodeURIComponent(`Windows Updates (Last 30 Days)\n\n${url}`);
    location.href = `mailto:?subject=Windows Updates (Last 30 Days)&body=${body}`;
  });

  function matchOs(e) {
    if (!state.os) return true;
    // If you later add OS info into data.json, filter here.
    // For now, show all.
    return true;
  }

  function render () {
    let rows = entries.slice();

    // search
    if (state.q) {
      rows = rows.filter(e =>
        (e.cve || '').toLowerCase().includes(state.q) ||
        (e.description || '').toLowerCase().includes(state.q)
      );
    }

    // os filter (noop for now)
    rows = rows.filter(matchOs);

    // sort
    if (state.sort === 'new') {
      rows.sort((a,b) => (b.releaseDate || '').localeCompare(a.releaseDate || ''));
    } else if (state.sort === 'old') {
      rows.sort((a,b) => (a.releaseDate || '').localeCompare(b.releaseDate || ''));
    } else if (state.sort === 'cve') {
      rows.sort((a,b) => (a.cve || '').localeCompare(b.cve || ''));
    }

    counter.textContent = `${rows.length} update${rows.length===1?'':'s'}`;

    // paint
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (const e of rows) {
      const tr = document.createElement('tr');
      tr.className = 'row';

      const cvetd = document.createElement('td');
      cvetd.className = 'cell';
      const a = document.createElement('a');
      a.className = 'link';
      a.href = e.url || '#';
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = e.cve || '(unknown CVE)';
      cvetd.appendChild(a);
      const sub = document.createElement('div');
      sub.className = 'subtle mono';
      const link = document.createElement('a');
      link.className = 'link';
      link.href = e.url || '#';
      link.target = '_blank';
      link.rel = 'noopener';
      link.textContent = 'link';
      sub.appendChild(link);
      const span = document.createElement('span');
      span.textContent = '  ' + (e.url || '');
      sub.appendChild(span);
      cvetd.appendChild(sub);

      const desctd = document.createElement('td');
      desctd.className = 'cell';
      desctd.textContent = e.description || '(no description)';

      const datetd = document.createElement('td');
      datetd.className = 'cell';
      datetd.textContent = fmtDate(e.releaseDate);

      const sourcetd = document.createElement('td');
      sourcetd.className = 'cell';
      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.textContent = e.source || '';
      sourcetd.appendChild(pill);

      tr.appendChild(cvetd);
      tr.appendChild(desctd);
      tr.appendChild(datetd);
      tr.appendChild(sourcetd);

      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  render();
})();
</script>
</body>
</html>
