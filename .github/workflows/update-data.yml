name: Update MSRC data JSON (daily)

on:
  schedule:
    - cron: "0 10 * * *"  # Runs daily at 10:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dateutil pytz

      - name: Build data.json (SUG + CVRF unified)
        env:
          OUTFILE: data.json
        run: |
          import json, requests, datetime, pytz, time
          from dateutil import parser

          print("Fetching latest data from Microsoft Security APIs...")

          def fetch_sug_data():
              url = "https://api.msrc.microsoft.com/sug/v2.0/en-US/updates"
              headers = {"Accept": "application/json"}
              params = {"$orderby": "releaseDate desc", "$top": 500}
              try:
                  r = requests.get(url, headers=headers, params=params, timeout=30)
                  if r.status_code == 999:
                      print("SUG throttled (HTTP 999), retrying...")
                      return None
                  r.raise_for_status()
                  return r.json().get("value", [])
              except Exception as e:
                  print(f"SUG fetch error: {e}")
                  return None

          def fetch_cvrf_data():
              url = "https://api.msrc.microsoft.com/cvrf/v2.0/en-US/updates"
              headers = {"Accept": "application/json"}
              try:
                  r = requests.get(url, headers=headers, timeout=30)
                  r.raise_for_status()
                  return r.json().get("value", [])
              except Exception as e:
                  print(f"CVRF fetch error: {e}")
                  return None

          sug_data = None
          for i in range(5):
              sug_data = fetch_sug_data()
              if sug_data: break
              time.sleep(25)
          if not sug_data:
              print("Falling back to CVRF feed...")
              sug_data = fetch_cvrf_data() or []

          updates = []
          now = datetime.datetime.now(pytz.UTC)
          cutoff = now - datetime.timedelta(days=30)

          for entry in sug_data:
              try:
                  release_date = parser.parse(entry.get("releaseDate", ""))
                  if release_date.tzinfo is None:
                      release_date = release_date.replace(tzinfo=pytz.UTC)
              except Exception:
                  continue

              if release_date < cutoff:
                  continue

              known_issue = (
                  entry.get("knownIssuesUrl")
                  or entry.get("releaseHealthUrl")
                  or entry.get("knownIssues")
                  or entry.get("links", {}).get("knownIssues")
              )

              kbs = []
              kb_field = (
                  entry.get("kbArticles")
                  or entry.get("kbArticleIds")
                  or entry.get("kbArticleId")
                  or entry.get("KBNumber")
              )
              if kb_field:
                  if isinstance(kb_field, list):
                      kbs = [f"KB{str(k)}" for k in kb_field]
                  else:
                      kbs = [f"KB{str(kb_field)}"]

              updates.append({
                  "cve": entry.get("cveNumber", "N/A"),
                  "title": entry.get("title", ""),
                  "description": entry.get("description", ""),
                  "kb": kbs,
                  "knownIssuesUrl": known_issue,
                  "releaseDate": release_date.isoformat(),
                  "source": "SUG RSS"
              })

          with open("data.json", "w", encoding="utf-8") as f:
              json.dump(updates, f, indent=2)

          print(f"Saved {len(updates)} updates to data.json")

      - name: Commit and push if changed
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add data.json || true
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update data.json" && git push)
