name: Build MSRC updates JSON (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: "9 9 * * *"  # 09:09 UTC daily

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dateutil

      - name: Build data.json (SUG v2 global API; robust date, pagination, retries)
        run: |
          python - << 'PY'
          import json, time, requests
          from datetime import datetime, timedelta, timezone
          from dateutil import parser as dtp

          OUT = "data.json"
          NOW = datetime.now(timezone.utc)
          SINCE = NOW - timedelta(days=30)

          def iso_to_utc(s):
              if not s:
                  return None
              try:
                  return dtp.isoparse(s).astimezone(timezone.utc)
              except Exception:
                  return None

          def best_date(u):
              # be forgiving – accept whichever exists
              for k in ("releaseDate", "currentReleaseDate", "lastModifiedDate"):
                  dt = iso_to_utc(u.get(k))
                  if dt:
                      return dt
              return None

          def fetch_json(url, tries=4, timeout=45):
              headers = {
                  "Accept": "application/json",
                  "User-Agent": "windows-update-board/2.0"
              }
              last_err = None
              for i in range(tries):
                  try:
                      r = requests.get(url, headers=headers, timeout=timeout)
                      if r.status_code in (429, 500, 502, 503, 504):
                          time.sleep(2 + i * 2)
                          last_err = Exception(f"HTTP {r.status_code}")
                          continue
                      r.raise_for_status()
                      return r.json()
                  except Exception as e:
                      last_err = e
                      time.sleep(1 + i * 2)
              raise last_err

          base = "https://api.msrc.microsoft.com/sug/v2.0/updates"
          # Pull only what we need; order by lastModifiedDate to catch “just posted” rows
          first = f"{base}?$select=title,cveIds,releaseDate,currentReleaseDate,lastModifiedDate&$orderby=lastModifiedDate desc&$top=500"

          all_rows = []
          url = first
          while url:
              data = fetch_json(url)
              chunk = data.get("value", [])
              all_rows.extend(chunk)
              url = data.get("@odata.nextLink")

          print(f"SUG raw items seen: {len(all_rows)}")

          seen = set()
          entries = []

          for u in all_rows:
              # CVEs come as an array (sometimes None/empty)
              cves = u.get("cveIds") or []
              title = (u.get("title") or "").strip() or "(no description)"
              dt = best_date(u)

              # Keep the row if we can find *any* of the date fields and it’s in-window
              if not dt:
                  continue
              if not (SINCE <= dt <= NOW):
                  continue

              for cve in cves:
                  cve = (cve or "").strip()
                  if not cve:
                      continue
                  key = (cve, dt.date().isoformat())
                  if key in seen:
                      continue
                  seen.add(key)
                  entries.append({
                      "cve": cve,
                      "url": f"https://msrc.microsoft.com/update-guide/vulnerability/{cve}",
                      "releaseDate": dt.date().isoformat(),
                      "source": "MSRC-SUG",
                      "description": title
                  })

          print(f"Entries kept (last 30 days): {len(entries)}")

          # If SUG is being stingy today, do not blow away prior data.json silently.
          # Only overwrite with an empty list if no data.json exists yet.
          try:
              old = json.load(open(OUT, "r", encoding="utf-8"))
          except Exception:
              old = None

          # Sort newest first for stable UI behavior
          entries.sort(key=lambda e: (e["releaseDate"], e["cve"]), reverse=True)

          if entries or old is None:
              with open(OUT, "w", encoding="utf-8") as f:
                  json.dump(entries, f, ensure_ascii=False, indent=2)
              print(f"Wrote {len(entries)} rows to {OUT}.")
          else:
              print("WARNING: No entries today. Preserving existing data.json.")

          PY

      - name: Commit if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): MSRC SUG v2 (robust date + pagination)"
          file_pattern: data.json
