name: Build MSRC updates JSON (daily)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 9 * * *"  # runs daily at 09:00 UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch Microsoft Security Updates (last 30 days)
        run: |
          echo "Fetching CSV from MSRC feed..."
          FEED_URL="https://www.catalog.update.microsoft.com/DownloadDialog.aspx"

          # Microsoft Security Update Guide (SUG) CSV feed URL
          CSV_URL="https://api.msrc.microsoft.com/cvrf/v2.0/updates?format=csv"

          # Download CSV feed to temp file
          curl -s -A "Mozilla/5.0" -H "Accept: text/csv" "https://api.msrc.microsoft.com/sug/v2.0/en-US/updates" -o updates.csv

          # Parse last 30 days only and convert to JSON
          awk -F, -v date="$(date -d '30 days ago' +%Y-%m-%d)" '
            BEGIN {
              print "["
            }
            NR>1 {
              gsub(/"/, "", $0)
              if ($1 >= date) {
                printf("{\"date\":\"%s\",\"kb\":\"%s\",\"description\":\"%s\",\"os\":\"%s\",\"severity\":\"%s\",\"url\":\"https://support.microsoft.com/help/%s\",\"knownIssuesUrl\":\"https://learn.microsoft.com/en-us/windows/release-health/\"},\n",
                  $1, $2, $3, $4, $5, $2)
              }
            }
            END {
              print "]"
            }
          ' updates.csv > data.json

          echo "âœ… Generated data.json:"
          head -n 10 data.json

      - name: Commit updated data.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update data.json (daily)"
          file_pattern: data.json
