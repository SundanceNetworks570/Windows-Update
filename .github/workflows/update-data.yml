name: Build MSRC updates JSON (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * *"  # Daily at 9 AM UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dateutil xmltodict

      - name: Build data.json (last 30 days; robust date fallback; skip missing months)
        run: |
          python - << 'PY'
          import json, unicodedata
          from datetime import datetime, timedelta, timezone
          import requests, xmltodict
          from dateutil.parser import isoparse

          NOW = datetime.now(timezone.utc)
          SINCE = NOW - timedelta(days=30)
          CVRF_BASE = "https://api.msrc.microsoft.com/cvrf/v3.0/cvrf"

          def month_labels(start, end):
            cur = datetime(start.year, start.month, 1, tzinfo=timezone.utc)
            labels = []
            while cur <= end:
              labels.append(cur.strftime("%Y-%b"))
              ny = cur.year + (1 if cur.month == 12 else 0)
              nm = 1 if cur.month == 12 else cur.month + 1
              cur = datetime(ny, nm, 1, tzinfo=timezone.utc)
            return labels

          def clean_bytes(b):
            if not b: return ""
            b = b.replace(b"\xef\xbb\xbf", b"").replace(b"\x00", b"")
            s = b.decode("utf-8", "ignore")
            s = "".join(ch for ch in s if unicodedata.category(ch)[0] != "C" or ch in "\n\r\t")
            if "<html" in s[:400].lower():
              return ""
            return s.strip()

          def get_cvrf_month(label):
            url = f"{CVRF_BASE}/{label}"
            try:
              r = requests.get(url, headers={"Accept": "application/xml"}, timeout=20)
              if r.status_code == 404:
                print(f"⚠️ Skipping {label}: no data available (404)")
                return None
              r.raise_for_status()
              xml = clean_bytes(r.content)
              if not xml:
                print(f"⚠️ Skipping {label}: empty or invalid XML")
                return None
              return xmltodict.parse(xml)
            except Exception as e:
              print(f"⚠️ Skipping {label}: {e}")
              return None

          def safe_get(d, path, default=None):
            cur = d
            for p in path:
              if not isinstance(cur, dict):
                return default
              cur = cur.get(p)
            return cur if cur is not None else default

          def to_utc(dtstr):
            try:
              return isoparse(dtstr).astimezone(timezone.utc)
            except Exception:
              return None

          def newest_revision_date(doc):
            revs = safe_get(doc, ["cvrfdoc", "cvrf:DocumentTracking", "cvrf:RevisionHistory", "cvrf:Revision"])
            if not revs:
              return None
            if isinstance(revs, dict):
              revs = [revs]
            dates = []
            for r in revs:
              d = safe_get(r, ["cvrf:Date"])
              dt = to_utc(d) if d else None
              if dt:
                dates.append(dt)
            return max(dates) if dates else None

          def pick_doc_date(doc, label):
            # 1) CurrentReleaseDate
            cur = safe_get(doc, ["cvrfdoc", "cvrf:DocumentTracking", "cvrf:CurrentReleaseDate"])
            cur_dt = to_utc(cur) if cur else None
            if cur_dt:
              print(f"ℹ️ {label}: using CurrentReleaseDate = {cur_dt.date()}")
              return cur_dt

            # 2) Newest RevisionHistory date
            rev_dt = newest_revision_date(doc)
            if rev_dt:
              print(f"ℹ️ {label}: using RevisionHistory latest = {rev_dt.date()}")
              return rev_dt

            # 3) InitialReleaseDate
            init = safe_get(doc, ["cvrfdoc", "cvrf:DocumentTracking", "cvrf:InitialReleaseDate"])
            init_dt = to_utc(init) if init else None
            if init_dt:
              print(f"ℹ️ {label}: using InitialReleaseDate = {init_dt.date()}")
              return init_dt

            print(f"⚠️ {label}: no usable document date found")
            return None

          rows = []

          for label in month_labels(SINCE, NOW):
            doc = get_cvrf_month(label)
            if not doc:
              continue

            doc_dt = pick_doc_date(doc, label)
            if not doc_dt:
              continue

            if not (SINCE <= doc_dt <= NOW):
              print(f"ℹ️ {label}: doc date {doc_dt.date()} outside window")
              continue

            vulns = safe_get(doc, ["cvrfdoc", "cvrf:Vulnerability"])
            if not vulns:
              continue
            if isinstance(vulns, dict):
              vulns = [vulns]

            for v in vulns:
              cve = safe_get(v, ["cvrf:CVE"])
              if not cve:
                continue
              rows.append({
                "cve": cve,
                "url": f"https://msrc.microsoft.com/update-guide/vulnerability/{cve}",
                "releaseDate": doc_dt.strftime("%Y-%m-%d"),
                "source": label
              })

          # de-dupe by (CVE, releaseDate)
          seen = set()
          out = []
          for r in rows:
            key = (r["cve"], r["releaseDate"])
            if key not in seen:
              seen.add(key)
              out.append(r)

          out.sort(key=lambda x: x["releaseDate"], reverse=True)

          with open("data.json", "w", encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)

          print(f"✅ Completed. {len(out)} updates written (window {SINCE.date()}–{NOW.date()})")
          PY

      - name: Commit if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): daily MSRC data.json update"
          file_pattern: data.json
