name: Build MSRC updates JSON (daily)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 9 * * *"  # runs daily at 09:00 UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build data.json with PowerShell
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "Starting MSRC data fetch..."

          $DaysBack = 30
          $Since = (Get-Date).ToUniversalTime().AddDays(-$DaysBack).ToString("o")
          $ApiBase = "https://api.msrc.microsoft.com/cvrf/v3.0"

          try {
            Write-Host "Fetching update list from MSRC..."
            $updatesUrl = "$ApiBase/updates/?`$filter=InitialReleaseDate ge $Since or CurrentReleaseDate ge $Since&`$orderby=CurrentReleaseDate desc"
            $updates = Invoke-RestMethod -Uri $updatesUrl -Headers @{Accept="application/json"} -ErrorAction Stop
          } catch {
            Write-Host "❌ Failed to fetch updates from MSRC: $($_.Exception.Message)"
            Set-Content -Path "data.json" -Value "[]" -Encoding utf8
            exit 0
          }

          if (-not $updates.value) {
            Write-Host "⚠️ No updates found in the last 30 days."
            Set-Content -Path "data.json" -Value "[]" -Encoding utf8
            exit 0
          }

          Write-Host "Processing updates..."
          $rows = @()
          foreach ($u in ($updates.value | Sort-Object CurrentReleaseDate -Descending)) {
            $date = if ($u.CurrentReleaseDate) { $u.CurrentReleaseDate } else { $u.InitialReleaseDate }
            $id = $u.ID
            $title = $u.Title
            $kb = ([regex]::Match($title, 'KB\d{7,8}', 'IgnoreCase')).Value

            if (-not $kb) { continue }
            $rows += [pscustomobject]@{
              date = $date
              kb = $kb
              url = "https://support.microsoft.com/help/$($kb -replace 'KB','')"
              description = $title
              knownIssuesUrl = "https://learn.microsoft.com/en-us/windows/release-health/"
              os = "Windows"
              severity = "Unknown"
            }
          }

          $count = $rows.Count
          Write-Host "✅ Processed $count updates."
          if ($count -eq 0) {
            Write-Host "⚠️ No entries parsed. Writing empty JSON."
          }

          $json = $rows | ConvertTo-Json -Depth 5
          Set-Content -Path "data.json" -Value $json -Encoding utf8

      - name: Commit data.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update data.json (daily)"
          file_pattern: data.json
