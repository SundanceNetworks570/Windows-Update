name: Build MSRC updates JSON (daily)

on:
  schedule:
    - cron: "9 9 * * *"  # Daily at 09:09 UTC
  workflow_dispatch:
    inputs:
      days_back:
        description: "Number of days back to collect"
        required: false
        default: "7"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests httpx xmltodict python-dateutil pytz

      - name: Build data.json (SUG first; CVRF fallback)
        env:
          MSRC_API_KEY: ${{ secrets.MSRC_API_KEY }}
          DAYS_BACK_INPUT: ${{ github.event.inputs.days_back }}
        run: |
          python - <<'PY'
          import os, json, time, random, unicodedata
          from datetime import datetime, timedelta, timezone
          from dateutil.parser import isoparse
          import requests, httpx, xmltodict

          NOW = datetime.now(timezone.utc)
          days_back = int(os.getenv("DAYS_BACK_INPUT") or "7")
          SINCE = NOW - timedelta(days=days_back)

          def log(msg): print(msg, flush=True)

          def clean_bytes(b: bytes) -> str:
              b = b.replace(b"\xef\xbb\xbf", b"").replace(b"\x00", b"")
              s = b.decode("utf-8", "ignore")
              s = "".join(ch for ch in s if unicodedata.category(ch)[0] != "C" or ch in "\n\r\t")
              return s.strip()

          def save_json(path, data):
              with open(path, "w", encoding="utf-8") as f:
                  json.dump(data, f, indent=2, ensure_ascii=False)

          HEADERS = {
              "Accept": "application/json",
              "User-Agent": "Mozilla/5.0",
          }
          if os.getenv("MSRC_API_KEY"):
              HEADERS["api-key"] = os.getenv("MSRC_API_KEY")

          def fetch_sug():
              url = "https://api.msrc.microsoft.com/sug/v2.0/updates?$top=100"
              for i in range(6):
                  try:
                      r = requests.get(url, headers=HEADERS, timeout=25)
                      if r.status_code in (429, 503, 999):
                          log(f"⚠️  Throttled (HTTP {r.status_code}); retrying in {10*(i+1)}s")
                          time.sleep(10*(i+1))
                          continue
                      r.raise_for_status()
                      return r.json().get("value", [])
                  except Exception as e:
                      log(f"⚠️  Error: {e}")
                      time.sleep(10*(i+1))
              return []

          def fetch_cvrf(month):
              url = f"https://api.msrc.microsoft.com/cvrf/v3.0/cvrf/{month}"
              try:
                  r = requests.get(url, headers={"Accept": "application/xml"}, timeout=30)
                  if r.status_code == 404:
                      return None
                  r.raise_for_status()
                  return xmltodict.parse(clean_bytes(r.content))
              except Exception as e:
                  log(f"⚠️  CVRF fetch error {month}: {e}")
                  return None

          items = fetch_sug()
          if not items:
              months = [NOW.strftime("%Y-%b"), (NOW - timedelta(days=30)).strftime("%Y-%b")]
              for m in months:
                  doc = fetch_cvrf(m)
                  if doc:
                      items.append({"title": f"CVRF {m}", "source": "fallback"})

          if not items:
              log("⚠️  No valid entries found; preserving old data.json if exists.")
              if os.path.exists("data.json"):
                  log("Keeping existing data.json.")
              else:
                  save_json("data.json", [])
          else:
              save_json("data.json", items)
              log(f"✅ Saved {len(items)} entries to data.json")
          PY

      - name: Commit if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update MSRC data.json"
          file_pattern: data.json
