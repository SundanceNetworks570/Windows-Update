name: Update MSRC + Windows Release Data (daily)

on:
  schedule:
    - cron: "9 9 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build combined data.json (MSRC + Windows Release)
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, re, sys, datetime, urllib.request, xml.etree.ElementTree as ET, pathlib

          # ---- Feeds ----
          MSRC_RSS = "https://api.msrc.microsoft.com/update-guide/rss"
          # This Microsoft "Release Health" feed works and does not 400:
          WIN_HEALTH_FEED = "https://learn.microsoft.com/en-us/feed/rss?category=Windows+Release+Health"

          KB_RE = re.compile(r"\bKB(\d{5,8})\b", re.IGNORECASE)
          CVE_RE = re.compile(r"\bCVE-\d{4}-\d{4,7}\b", re.IGNORECASE)

          def uniq(seq):
              seen=set(); out=[]
              for x in seq:
                  if x and x not in seen:
                      seen.add(x); out.append(x)
              return out

          def fetch(url):
              req = urllib.request.Request(url, headers={"User-Agent": "GitHubActionsBot"})
              with urllib.request.urlopen(req, timeout=40) as r:
                  return r.read()

          def parse_rss(url, source):
              try:
                  xml_data = fetch(url)
                  root = ET.fromstring(xml_data)
                  items = []
                  for it in root.findall(".//item"):
                      title = (it.findtext("title") or "").strip()
                      link = (it.findtext("link") or "").strip()
                      desc = (it.findtext("description") or "").strip()
                      pub = (it.findtext("pubDate") or "").strip()
                      items.append({"title": title, "description": desc, "link": link, "pubDate": pub, "source": source})
                  return items
              except Exception as e:
                  print(f"Failed {source}: {e}")
                  return []

          # ---- Get both feeds
          msrc = parse_rss(MSRC_RSS, "MSRC RSS")
          win = parse_rss(WIN_HEALTH_FEED, "Windows Health")

          all_items = msrc + win
          cutoff = datetime.datetime.utcnow() - datetime.timedelta(days=30)

          def keep_recent(it):
              pub = it.get("pubDate","")
              try:
                  dt = datetime.datetime.strptime(pub, "%a, %d %b %Y %H:%M:%S %Z")
              except:
                  return True
              return dt.replace(tzinfo=None) >= cutoff

          all_items = [x for x in all_items if keep_recent(x)]

          enriched = []
          for it in all_items:
              title, desc, link = it["title"], it["description"], it["link"]
              text = f"{title} {desc} {link}"
              cves = uniq([m.upper() for m in CVE_RE.findall(text)])
              kbs = uniq([("KB"+m).upper() for m in KB_RE.findall(text)])
              known_url = f"https://learn.microsoft.com/search/?terms={kbs[0]}%20known%20issues%20windows%20release%20health" if kbs else ""
              enriched.append({
                  "title": title,
                  "description": desc or "(no description)",
                  "link": link,
                  "releaseDate": it.get("pubDate",""),
                  "source": it.get("source",""),
                  "cves": cves,
                  "kbs": kbs,
                  "knownIssuesUrl": known_url,
                  "cve": ", ".join(cves),
                  "kb": ", ".join(kbs),
                  "knownIssues": known_url
              })

          enriched.sort(key=lambda x: x.get("releaseDate",""), reverse=True)

          out = json.dumps(enriched, indent=2, ensure_ascii=False)
          path = pathlib.Path("data.json")
          old = path.read_text(encoding="utf-8") if path.exists() else ""
          if out != old:
              path.write_text(out, encoding="utf-8")
              print(f"Wrote {len(enriched)} updates.")
          else:
              print("No new updates.")
          PY

      - name: Commit if changed
        run: |
          set -e
          if ! git diff --quiet -- data.json; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data.json
            git commit -m "update: MSRC + Windows Health feed"
            git push
          else
            echo "No changes."
