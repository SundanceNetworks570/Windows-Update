name: Build MSRC updates JSON (daily)

on:
  schedule:
    - cron: "9 9 * * *"  # Daily at 09:09 UTC
  workflow_dispatch:
    inputs:
      days_back:
        description: "Days of updates to include"
        required: false
        default: "30"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests xmltodict python-dateutil pytz

      - name: Build data.json (MSRC CVRF real data)
        env:
          DAYS_BACK_INPUT: ${{ github.event.inputs.days_back }}
        run: |
          python - <<'PY'
          import os, json, requests, xmltodict
          from datetime import datetime, timedelta, timezone
          from dateutil.parser import isoparse

          days_back = int(os.getenv("DAYS_BACK_INPUT") or "30")
          NOW = datetime.now(timezone.utc)
          SINCE = NOW - timedelta(days=days_back)

          def log(msg): print(msg, flush=True)

          def clean(s):
              if not s:
                  return ""
              if isinstance(s, dict):
                  s = s.get("#text", "")
              return str(s).replace("\n", " ").replace("\r", " ").strip()

          def fetch_cvrf(month):
              url = f"https://api.msrc.microsoft.com/cvrf/v3.0/cvrf/{month}"
              headers = {"Accept": "application/xml"}
              try:
                  r = requests.get(url, headers=headers, timeout=30)
                  if r.status_code == 404:
                      return None
                  r.raise_for_status()
                  return xmltodict.parse(r.text)
              except Exception as e:
                  log(f"⚠️ Error fetching {url}: {e}")
                  return None

          def parse_vulns(data):
              if not data: return []
              root = data.get("cvrfdoc", {})
              tracking = root.get("DocumentTracking", {})
              rel_date = tracking.get("CurrentReleaseDate") or tracking.get("InitialReleaseDate")
              if isinstance(rel_date, dict):
                  rel_date = rel_date.get("#text")
              try:
                  release_date = isoparse(rel_date)
              except Exception:
                  release_date = NOW
              if release_date < SINCE:
                  return []

              vulns = []
              v_items = root.get("Vulnerability", [])
              if isinstance(v_items, dict):
                  v_items = [v_items]

              for v in v_items:
                  cve = v.get("CVE") or "Unknown CVE"
                  title = clean(v.get("Title"))
                  desc = "(no description)"
                  if "Notes" in v:
                      notes = v["Notes"].get("Note") if isinstance(v["Notes"], dict) else []
                      if isinstance(notes, list):
                          for note in notes:
                              if note.get("@Type") == "Description":
                                  desc = clean(note.get("#text"))
                                  break
                      elif isinstance(notes, dict) and notes.get("@Type") == "Description":
                          desc = clean(notes.get("#text"))

                  severity = ""
                  threat = v.get("Threats", {}).get("Threat")
                  if isinstance(threat, dict):
                      severity = clean(threat.get("#text"))
                  elif isinstance(threat, list) and threat:
                      severity = clean(threat[0].get("#text"))

                  vulns.append({
                      "title": title or cve,
                      "cve": cve,
                      "description": desc,
                      "severity": severity or "n/a",
                      "releaseDate": release_date.strftime("%Y-%m-%d"),
                      "source": "MSRC CVRF"
                  })
              return vulns

          months = [NOW.strftime("%Y-%b"), (NOW - timedelta(days=30)).strftime("%Y-%b")]
          all_vulns = []
          for m in months:
              log(f"Fetching month: {m}")
              data = fetch_cvrf(m)
              vulns = parse_vulns(data)
              log(f"Extracted {len(vulns)} entries from {m}")
              all_vulns.extend(vulns)

          if not all_vulns:
              if os.path.exists("data.json"):
                  log("⚠️ No data found; preserving existing file.")
              else:
                  all_vulns = [{"title": "No updates found", "cve": "-", "description": "-", "releaseDate": NOW.strftime("%Y-%m-%d"), "source": "none"}]

          with open("data.json", "w", encoding="utf-8") as f:
              json.dump(all_vulns, f, indent=2, ensure_ascii=False)
              log(f"✅ Saved {len(all_vulns)} updates to data.json")
          PY

      - name: Commit if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update MSRC data.json"
          file_pattern: data.json
