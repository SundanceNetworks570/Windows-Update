name: Enrich MSRC data.json (add KBs, Known-Issues, back-compat)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  enrich:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Enrich data.json (KBs, Known Issues, CVEs + back-compat)
        run: |
          set -euo pipefail
          if [ ! -f data.json ]; then
            echo "data.json not found â€” nothing to enrich."
            exit 0
          fi

          python - << 'PYCODE'
          import json, re, sys, pathlib

          p = pathlib.Path("data.json")
          try:
              items = json.loads(p.read_text(encoding="utf-8"))
          except Exception as e:
              print("Failed to read data.json:", e)
              sys.exit(0)

          KB_RE = re.compile(r"\bKB(\d{5,8})\b", re.IGNORECASE)
          KB_URL_RE = re.compile(r"/kb/(\d{5,8})", re.IGNORECASE)
          CVE_RE = re.compile(r"\bCVE-\d{4}-\d{4,7}\b", re.IGNORECASE)

          def uniq(seq):
              seen = set(); out = []
              for x in seq:
                  if not x: continue
                  if x not in seen:
                      seen.add(x); out.append(x)
              return out

          changed = False
          for it in items if isinstance(items, list) else []:
              title = str(it.get("title",""))
              desc  = str(it.get("description",""))
              link  = str(it.get("link",""))
              text  = " ".join([title, desc, link])

              # --- Collect CVEs (keep existing if present) ---
              cves = []
              if isinstance(it.get("cves"), list):
                  cves.extend([str(x).upper() for x in it["cves"]])
              if not cves and it.get("cve"):
                  cves.extend([s.upper() for s in str(it["cve"]).split(",")])
              # pull from text if missing
              if not cves:
                  cves.extend([m.upper() for m in CVE_RE.findall(text)])

              # --- Collect KBs (prefer explicit list if present) ---
              kbs = []
              if isinstance(it.get("kbs"), list):
                  kbs.extend([("KB"+str(x).strip().lstrip("KB")).upper() for x in it["kbs"]])
              if it.get("kb"):
                  parts = [s.strip() for s in str(it["kb"]).replace(";",",").split(",")]
                  kbs.extend([("KB"+s.lstrip("KB")).upper() for s in parts if s])

              # regex from text/link/title
              kbs.extend([("KB"+m).upper() for m in KB_RE.findall(text)])
              kbs.extend([("KB"+m).upper() for m in KB_URL_RE.findall(text)])

              # de-dup
              cves = uniq(cves)
              kbs  = uniq(kbs)

              # --- Known Issues URL ---
              ki = it.get("knownIssuesUrl") or it.get("knownIssues") or ""
              if not ki and kbs:
                  kb = kbs[0]
                  ki = f"https://learn.microsoft.com/search/?terms={kb}%20known%20issues%20windows%20release%20health"

              # --- Write new canonical fields ---
              if cves: it["cves"] = cves
              if kbs:  it["kbs"]  = kbs
              if ki:   it["knownIssuesUrl"] = ki

              # --- Back-compat: keep old keys populated too ---
              it["cve"] = ", ".join(cves) if cves else it.get("cve","")
              it["kb"]  = ", ".join(kbs)  if kbs  else it.get("kb","")
              it["knownIssues"] = ki or it.get("knownIssues","")

          new = json.dumps(items, ensure_ascii=False, indent=2)
          old = p.read_text(encoding="utf-8")
          if new != old:
              p.write_text(new, encoding="utf-8")
              print("data.json enriched.")
          else:
              print("data.json unchanged.")

          PYCODE

      - name: Commit if changed
        run: |
          set -e
          if ! git diff --quiet -- data.json; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data.json
            git commit -m "enrich: add KBs, Known-Issues, CVEs + back-compat fields"
            git push
          else
            echo "No changes to commit."
          fi
