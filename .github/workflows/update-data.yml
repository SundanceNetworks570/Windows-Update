name: Build MSRC updates JSON (daily)

on:
  schedule:
    - cron: "15 9 * * *"  # daily at 09:15 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests xmltodict python-dateutil pytz

      - name: Build data.json (SUG + CVRF unified)
        run: |
          python - <<'PY'
          import json, requests, xmltodict
          from datetime import datetime, timedelta, timezone
          from dateutil.parser import isoparse

          NOW = datetime.now(timezone.utc)
          SINCE = NOW - timedelta(days=30)
          all_entries = []

          def log(msg): print(msg, flush=True)

          # --- SUG API ---
          try:
              log("Fetching SUG data...")
              sug_url = "https://api.msrc.microsoft.com/sug/v2.0/updates?$select=title,cveIds,releaseDate,lastModifiedDate,severity,releaseNumber&$orderby=lastModifiedDate desc&$top=200"
              r = requests.get(sug_url, timeout=30)
              if r.status_code == 200:
                  data = r.json().get("value", [])
                  for item in data:
                      rd = item.get("releaseDate")
                      if not rd: continue
                      try:
                          dt = isoparse(rd)
                      except Exception:
                          continue
                      if dt < SINCE: continue
                      all_entries.append({
                          "title": item.get("title", "(no title)"),
                          "cve": ", ".join(item.get("cveIds", [])) or "N/A",
                          "description": item.get("releaseNumber", "Windows Update"),
                          "severity": item.get("severity", "N/A"),
                          "releaseDate": dt.strftime("%Y-%m-%d"),
                          "source": "SUG"
                      })
                  log(f"SUG: {len(all_entries)} items collected")
              else:
                  log(f"SUG API error {r.status_code}")
          except Exception as e:
              log(f"⚠️ SUG fetch failed: {e}")

          # --- CVRF API ---
          def fetch_cvrf(month):
              url = f"https://api.msrc.microsoft.com/cvrf/v3.0/cvrf/{month}"
              try:
                  r = requests.get(url, headers={"Accept": "application/xml"}, timeout=30)
                  if r.status_code == 404: return None
                  r.raise_for_status()
                  return xmltodict.parse(r.text)
              except Exception as e:
                  log(f"⚠️ CVRF fetch {month} failed: {e}")
                  return None

          def parse_cvrf(doc):
              if not doc: return []
              root = doc.get("cvrfdoc", {})
              vulns = root.get("Vulnerability", [])
              if isinstance(vulns, dict): vulns = [vulns]
              results = []
              for v in vulns:
                  cve = v.get("CVE") or "Unknown CVE"
                  title = v.get("Title") or "(no title)"
                  desc = "(no description)"
                  if "Notes" in v:
                      notes = v["Notes"].get("Note") if isinstance(v["Notes"], dict) else []
                      if isinstance(notes, list):
                          for n in notes:
                              if n.get("@Type") == "Description":
                                  desc = n.get("#text", "")
                                  break
                      elif isinstance(notes, dict) and notes.get("@Type") == "Description":
                          desc = notes.get("#text", "")
                  results.append({
                      "title": title,
                      "cve": cve,
                      "description": desc,
                      "severity": "N/A",
                      "releaseDate": datetime.now().strftime("%Y-%m-%d"),
                      "source": "CVRF"
                  })
              return results

          for m in [NOW.strftime("%Y-%b"), (NOW - timedelta(days=30)).strftime("%Y-%b")]:
              data = fetch_cvrf(m)
              parsed = parse_cvrf(data)
              if parsed:
                  log(f"CVRF: {len(parsed)} from {m}")
                  all_entries.extend(parsed)

          # --- Write Output ---
          all_entries = sorted(all_entries, key=lambda x: x["releaseDate"], reverse=True)
          with open("data.json", "w", encoding="utf-8") as f:
              json.dump(all_entries, f, indent=2, ensure_ascii=False)
          log(f"✅ Total entries saved: {len(all_entries)}")
          PY

      - name: Commit if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "update data.json (CVRF+SUG)"
          file_pattern: data.json
