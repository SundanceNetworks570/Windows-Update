name: Build MSRC updates JSON (daily)

on:
  workflow_dispatch:   # ðŸ‘ˆ Enables the "Run workflow" button
  schedule:
    - cron: "0 9 * * *"  # Runs daily at 9 AM UTC

      - name: Build data.json (today back 30 days; ultra-robust CVRF parsing)
        run: |
          python - << 'PY'
          import json, re, unicodedata
          from datetime import datetime, timedelta, timezone
          from dateutil.parser import isoparse
          import requests, xmltodict

          NOW = datetime.now(timezone.utc)
          SINCE = NOW - timedelta(days=30)
          CVRF = "https://api.msrc.microsoft.com/cvrf/v3.0"

          def clean_bytes(b: bytes) -> str:
              if not b:
                  return ""
              # remove BOMs, nulls, invisible control chars
              b = b.replace(b"\xef\xbb\xbf", b"").replace(b"\x00", b"")
              s = b.decode("utf-8", "ignore")
              s = "".join(ch for ch in s if unicodedata.category(ch)[0] != "C" or ch in "\n\r\t")
              s = s.lstrip()
              # drop junk before first '<'
              i = s.find("<")
              if i > 0:
                  s = s[i:]
              if s[:15].lower().startswith("<!doctype html") or "<html" in s[:200].lower():
                  return ""
              return s

          def get_json(url):
              r = requests.get(url, headers={"Accept":"application/json"})
              r.raise_for_status()
              return r.json()

          def get_xml(url):
              r = requests.get(url, headers={"Accept":"application/xml"})
              r.raise_for_status()
              txt = clean_bytes(r.content)
              if not txt:
                  return None
              try:
                  return xmltodict.parse(txt, process_namespaces=False)
              except Exception as e:
                  # second-pass cleanup if first parse fails
                  txt = re.sub(r"[^\x09\x0A\x0D\x20-\x7E\xA0-\uFFFF]", "", txt)
                  try:
                      return xmltodict.parse(txt, process_namespaces=False)
                  except Exception:
                      print(f"Skip malformed XML from {url}: {e}")
                      return None

          since_iso = SINCE.strftime("%Y-%m-%dT%H:%M:%SZ")
          updates_url = f"{CVRF}/updates/?$filter=(InitialReleaseDate ge {since_iso} or CurrentReleaseDate ge {since_iso})&$orderby=CurrentReleaseDate desc"
          updates = get_json(updates_url).get("value", [])
          print(f"Found {len(updates)} CVRF update documents in window {SINCE.date()}..{NOW.date()}")

          kb_re = re.compile(r"KB\d{7,8}", re.I)
          rows = []

          for u in updates:
              doc_id = u.get("ID")
              if not doc_id:
                  continue
              url = f"{CVRF}/cvrf/{doc_id}"
              x = get_xml(url)
              if not x:
                  continue
              vulns = x["cvrfdoc"].get("Vulnerability", [])
              if isinstance(vulns, dict): vulns=[vulns]
              for v in vulns:
                  rems = v.get("Remediations",{}).get("Remediation",[])
                  if isinstance(rems, dict): rems=[rems]
                  for r in rems:
                      d = r.get("Description","")
                      m = kb_re.search(d)
                      if not m: continue
                      rows.append({
                          "kb": m.group(0),
                          "desc": d[:120]
                      })
              if rows:
                  print(f"Parsed bulletin {doc_id} with {len(rows)} KBs")
                  break

          with open("data.json","w",encoding="utf-8") as f:
              json.dump(rows, f, ensure_ascii=False, indent=2)
          print(f"Wrote {len(rows)} rows to data.json")
          PY
