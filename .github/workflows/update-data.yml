name: Build MSRC updates JSON (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: "9 9 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dateutil

      - name: Build data.json (SUG v2 global API; includes description)
        run: |
          python - << 'PY'
          import requests, json, re
          from datetime import datetime, timedelta, timezone
          from dateutil import parser as dtp

          OUT = "data.json"
          NOW = datetime.now(timezone.utc)
          SINCE = NOW - timedelta(days=30)

          def safe_date(s):
              try:
                  return dtp.isoparse(s).astimezone(timezone.utc)
              except Exception:
                  return None

          entries, seen = [], set()

          # âœ… Updated API endpoint (global, not en-US)
          SUG_URL = "https://api.msrc.microsoft.com/sug/v2.0/updates"

          print(f"Fetching data from: {SUG_URL}")
          try:
              r = requests.get(SUG_URL, timeout=45)
              r.raise_for_status()
              data = r.json()
              for u in data.get("value", []):
                  title = (u.get("Title") or "").strip()
                  pub = safe_date(u.get("ReleaseDate"))
                  if not pub or not (SINCE <= pub <= NOW):
                      continue
                  for cve in (u.get("CVEIDs") or []):
                      key = (cve, pub.date().isoformat())
                      if key in seen: 
                          continue
                      seen.add(key)
                      entries.append({
                          "cve": cve,
                          "url": f"https://msrc.microsoft.com/update-guide/vulnerability/{cve}",
                          "releaseDate": pub.date().isoformat(),
                          "source": "MSRC-SUG",
                          "description": title or "(no description)"
                      })
              print(f"Collected {len(entries)} entries from SUG API.")
          except Exception as e:
              print(f"WARNING: SUG API failed: {e}")

          # --- Sort and save ---
          entries.sort(key=lambda e: (e["releaseDate"], e["cve"]), reverse=True)
          print(f"Writing {len(entries)} entries covering {SINCE.date()}..{NOW.date()}")
          with open(OUT, "w", encoding="utf-8") as f:
              json.dump(entries, f, ensure_ascii=False, indent=2)
          PY

      - name: Commit if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): MSRC updates via global SUG v2 API"
          file_pattern: data.json
